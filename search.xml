<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>æœ¬åœ°åŒ–å­˜å‚¨æŠ€æœ¯-IndexedDBï½œlocalForage</title>
      <link href="/2024/11/18/article1/"/>
      <url>/2024/11/18/article1/</url>
      
        <content type="html"><![CDATA[<p> <strong>å‰è¨€ï¼š</strong><br>LocalStorageæ˜¯æµè§ˆå™¨å­˜å‚¨è½»é‡æ•°æ®çš„ä¸€ä¸ªæ–¹å¼ï¼Œå¹³å¸¸åœ¨æœ¬åœ°åŒ–å­˜å‚¨æ—¶å¯èƒ½ä¼šä½¿ç”¨åˆ°ï¼Œä½†åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šå‘ç°localStorageå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li><strong>å­˜å‚¨é‡å°ï¼Œå¡é¡¿é—®é¢˜</strong>ï¼š é€šå¸¸é™åˆ¶åœ¨ 5MB å·¦å³ï¼ˆå…·ä½“å–å†³äºæµè§ˆå™¨ï¼‰ï¼Œå¦‚æœå­—ç¬¦ä¸²è¿‡é•¿ï¼Œä¼šå­˜ä¸ä¸‹å¯¼è‡´å¡æ­»ï¼Œå­˜å‚¨å†…å®¹å¤šä¼šæ¶ˆè€—å†…å­˜ç©ºé—´</li><li><strong>å­˜å–ä¸æ–¹ä¾¿ï¼š</strong>  é’ˆå¯¹éå­—ç¬¦ä¸²ï¼šå­˜å‚¨éœ€è¦åºåˆ—åŒ–ä¸ºï¼Œå–å€¼æ—¶ååºåˆ—åŒ–ï¼Œæ“ä½œ ä¸æ–¹ä¾¿</li><li><strong>Key-valueæ··ä¹±</strong></li></ul><p><strong>LocalStorage çš„é€‚ç”¨åœºæ™¯</strong></p><ol><li>ç”¨æˆ·é¦–é€‰é¡¹ï¼ˆå¦‚æš—é»‘æ¨¡å¼ã€è¯­è¨€è®¾ç½®ï¼‰</li><li>ç¼“å­˜ç®€å•çš„æ•°æ®ï¼ˆå¦‚è¡¨å•è‰ç¨¿ï¼‰</li><li>è½»é‡çº§çš„ç¦»çº¿åŠŸèƒ½æ”¯æŒ</li></ol><br/><p>å¯¹äºæ›´å¤æ‚çš„åœºæ™¯ï¼ˆå¦‚éœ€è¦å­˜å‚¨å¤§é‡æ•°æ®æˆ–æ”¯æŒå¼‚æ­¥æ“ä½œï¼‰ï¼Œæ¨èä½¿ç”¨ IndexedDB æˆ–å°è£…åº“ localForageï¼š</p><h1 id="IndexedDB"><a href="#IndexedDB" class="headerlink" title="IndexedDB"></a>IndexedDB</h1><p>IndexedDB æ˜¯ä¸€ä¸ªåŸºäº JS çš„é¢å‘å¯¹è±¡æ•°æ®åº“ã€‚<br>å…è®¸å­˜å‚¨å’Œæ£€ç´¢ç”¨é”®ç´¢å¼•çš„å¯¹è±¡ï¼›å¯ä»¥å­˜å‚¨ç»“æ„åŒ–å…‹éš†ç®—æ³•æ”¯æŒçš„ä»»ä½•å¯¹è±¡ã€‚</p><p> <strong>ä¼˜ç‚¹</strong></p><ul><li><strong>å­˜å‚¨å¤§</strong>ï¼šæ”¯æŒå­˜å‚¨å¤§é‡ç»“æ„åŒ–æ•°æ®</li><li><strong>çµæ´»æ€§</strong>ï¼šæ”¯æŒå¤æ‚çš„æŸ¥è¯¢ã€é”®ç´¢å¼•ã€å¤šç§æ•°æ®ç±»å‹ç­‰</li><li><strong>å¼‚æ­¥å­˜å–</strong>  IndexedDB çš„è¯»å–å’Œå­˜å‚¨éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šé˜»å¡æµè§ˆå™¨è¿›ç¨‹</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li>å¤æ‚æ€§ï¼šä½¿ç”¨èµ·æ¥ç›¸å¯¹å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜</li></ul><br><p>å­¦ä¹ æˆæœ¬å¤ªé«˜æ€ä¹ˆåŠï¼Ÿ<br>ä¸æ…Œï¼Œæ—©å°±æœ‰å¤§ä½¬ä¸ºæˆ‘ä»¬å°è£…å¥½äº†ï¼Œä¸»è§’ç™»åœºï½</p><h1 id="å°è£…IndexedDBï¼šlocalForage"><a href="#å°è£…IndexedDBï¼šlocalForage" class="headerlink" title="å°è£…IndexedDBï¼šlocalForage"></a>å°è£…IndexedDBï¼šlocalForage</h1><p><strong>localForage</strong> æ˜¯ä¸€ä¸ªå°è£…åº“ï¼Œç®€åŒ–äº† IndexedDB çš„ä½¿ç”¨ï¼ŒåŒæ—¶è¿˜æä¾›äº†å¯¹å…¶ä»–å­˜å‚¨æœºåˆ¶ï¼ˆå¦‚ LocalStorage å’Œ WebSQLï¼‰çš„ç»Ÿä¸€æ¥å£ã€‚</p><p>åœ°å€ï¼š</p><blockquote><p><a href="https://github.com/localForage/localForage">https://github.com/localForage/localForage</a></p></blockquote><p>æ–‡æ¡£ï¼š</p><blockquote><p><a href="https://localforage.github.io/localForage/">https://localforage.github.io/localForage/</a><br><a href="https://localforage.docschina.org/">https://localforage.docschina.org/</a>ï¼ˆä¸­æ–‡ï¼‰</p></blockquote><h2 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h2><ul><li><strong>ç»Ÿä¸€ API</strong>ï¼šæ— è®ºåº•å±‚ä½¿ç”¨ IndexedDBã€LocalStorage æˆ– WebSQLï¼ŒAPI å§‹ç»ˆä¿æŒä¸€è‡´ã€‚</li><li><strong>è‡ªåŠ¨é™çº§</strong>ï¼šlocalForage æœ‰ä¸€ä¸ªä¼˜é›…é™çº§ç­–ç•¥ï¼Œè‹¥æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB æˆ– WebSQLï¼Œ åˆ™ä½¿ç”¨localStorageã€‚</li><li><strong>å¼‚æ­¥æ“ä½œï¼š</strong> åŸºäº Promise çš„å¼‚æ­¥æ¥å£ï¼Œé¿å…äº†å›è°ƒåœ°ç‹±ã€‚</li></ul><p>ç›®å‰åœ¨æ‰€æœ‰ä¸»æµæµè§ˆå™¨ä¸­éƒ½å¯ç”¨ï¼šChrome, Firefox, IE å’Œ Safariï¼ˆåŒ…æ‹¬ Safari Mobile)</p><h2 id="CRUDä½¿ç”¨"><a href="#CRUDä½¿ç”¨" class="headerlink" title="CRUDä½¿ç”¨"></a>CRUDä½¿ç”¨</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">localforage.setItem(&quot;key&quot;, &#123; id: 1, name: &quot;item1&quot; &#125;).then((value) =&gt; &#123;</span><br><span class="line">  console.log(&quot;Stored value:&quot;, value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p>æ›´å¤šè¯¦æƒ…ä½¿ç”¨å¯ä»¥çœ‹æ–‡æ¡£</p></blockquote><ol><li>åˆ›å»ºä¸€ä¸ª indexedDB</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myIndexedDB = localforage.<span class="title function_">createInstance</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;myIndexedDB&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ol start="2"><li>å­˜å€¼</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myIndexedDB.<span class="title function_">setItem</span>(key, value)</span><br></pre></td></tr></table></figure><ol start="3"><li>å–å€¼<br>indexedDBå­˜å–æ˜¯å¼‚æ­¥çš„ï¼Œå»ºè®®ä½¿ç”¨ promise.then() æˆ– async&#x2F;await å»è¯»å€¼</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myIndexedDB.<span class="title function_">getItem</span>(<span class="string">&#x27;somekey&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="comment">// we got our value</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">  <span class="comment">// we got an error</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> value = <span class="keyword">await</span> myIndexedDB.<span class="title function_">getItem</span>(<span class="string">&#x27;somekey&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>åˆ é™¤æŸé¡¹</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myIndexedDB.<span class="title function_">removeItem</span>(<span class="string">&#x27;somekey&#x27;</span>)</span><br></pre></td></tr></table></figure><ol start="5"><li>é‡ç½®æ•°æ®åº“</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myIndexedDB.<span class="title function_">clear</span>()</span><br></pre></td></tr></table></figure><h2 id="å¤šå®ä¾‹"><a href="#å¤šå®ä¾‹" class="headerlink" title="å¤šå®ä¾‹"></a>å¤šå®ä¾‹</h2><p>åœ¨æœ‰å¤šä¸ªæ¨¡å—éœ€è¦ä½¿ç”¨æœ¬åœ°æ‘ç²—ä½¿ï¼Œå¯ä»¥åˆ†æ¨¡å—åˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚<br>ä¾‹å¦‚ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eryaDB</span>: localforage.<span class="title function_">createInstance</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;eryaDB&#x27;</span>,</span><br><span class="line">&#125;),</span><br><span class="line"><span class="attr">csdnDB</span>: localforage.<span class="title function_">createInstance</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;csdnDB&#x27;</span>,</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure><p>å¯ä»¥åˆ†åˆ«ä½œä¸ºä¸€ä¸ªStateï¼Œåœ¨é¡µé¢ä¸­åˆ†åˆ«ç›´æ¥è°ƒå–ä½¿ç”¨</p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æµè§ˆå™¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‰ç«¯å®ç°CodeDiffç»„ä»¶</title>
      <link href="/2024/09/11/article6/"/>
      <url>/2024/09/11/article6/</url>
      
        <content type="html"><![CDATA[<h1 id="å®ç°æ•ˆæœåŠä½¿ç”¨æ–¹æ³•"><a href="#å®ç°æ•ˆæœåŠä½¿ç”¨æ–¹æ³•" class="headerlink" title="å®ç°æ•ˆæœåŠä½¿ç”¨æ–¹æ³•"></a>å®ç°æ•ˆæœåŠä½¿ç”¨æ–¹æ³•</h1><p>æœ€ç»ˆå®ç°æ•ˆæœä¸gitlabä»£ç å¯¹æ¯”ç±»ä¼¼<br><img src="/img/article6/article6_show.gif" style="width: 400px"></p><p>è¯¥ç»„ä»¶æ»¡è¶³ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ol><li>å±•ç¤ºå˜æ›´è¡Œçš„ä»£ç ï¼šå±•ç¤ºå˜æ›´è¡Œï¼Œæœªå˜æ›´çš„åœ°æ–¹ä¼šæ ¹æ®éœ€æ±‚æŠ˜å ï¼ˆè¶…è¿‡10è¡ŒæŠ˜å ï¼‰ã€‚</li><li>æ˜¾ç¤ºä¸€è‡´çš„ä»£ç ï¼š å¯¹äºä¸¤æ®µä»£ç å®Œå…¨ä¸€è‡´çš„æƒ…å†µï¼Œå±•ç¤ºæ—¶ä¸ä¼šåŠ ä¸Šä»»ä½•æ ‡è®°æˆ–æ ·å¼ï¼Œæ¯”å¦‚åŠ è‰²ã€åˆ é™¤ç­‰ï¼Œä»£ç è¡Œå®Œå…¨æŒ‰ç…§åŸæ ·æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯ä»…ä»…æ˜¾ç¤ºç©ºçš„diffã€‚</li></ol><p><b>ä½¿ç”¨æ–¹å¼ï¼š</b></p><ul><li>oldString {string} å˜æ›´å‰å†…å®¹</li><li>newString {string} å˜æ›´åå†…å®¹</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">CodeDiff</span></span><br><span class="line">  oldString=&#123;oldString || <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">  newString=&#123;newString || <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure><img src="/img/article6/article6_case.png" style="width: 600px"><h1 id="è®¾è®¡æ€è·¯"><a href="#è®¾è®¡æ€è·¯" class="headerlink" title="è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h1><h2 id="ä½¿ç”¨-unidiff-è·å–å·®å¼‚"><a href="#ä½¿ç”¨-unidiff-è·å–å·®å¼‚" class="headerlink" title="ä½¿ç”¨ unidiff è·å–å·®å¼‚"></a>ä½¿ç”¨ unidiff è·å–å·®å¼‚</h2><blockquote><p>unidiffåº“ åŸºäº å…¬å…±åº“<a href="https://www.npmjs.com/package/diff">diff</a>ï¼ˆç®—æ³•åŸºäº<a href="http://www.xmailserver.org/diff2.pdf">An O(ND) Difference Algorithm and Its Variationsâˆ—</a>ï¼‰ ã€‚ç”¨äºæ–‡æœ¬å·®å¼‚è®¡ç®—ï¼ŒåŸºäºMyersç®—æ³•ï¼Œèƒ½å¤Ÿå¯¹å­—ç¬¦ä¸²è¿›è¡Œdiffæ“ä½œï¼Œè¿”å›å˜æ›´å¯¹è±¡çš„åˆ—è¡¨ï¼Œå¹¶ä¸”æ”¯æŒç”Ÿæˆç»Ÿä¸€æ ¼å¼çš„è¾“å‡ºã€‚</p></blockquote><p>ä½¿ç”¨<a href="https://www.npmjs.com/package/unidiff">unidiff</a>åº“æ¥è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å·®å¼‚ï¼Œè¿”å›å·®å¼‚ç»“æœ<code>diffLines()</code></p><h2 id="å·®å¼‚ç»“æœå±•ç¤º"><a href="#å·®å¼‚ç»“æœå±•ç¤º" class="headerlink" title="å·®å¼‚ç»“æœå±•ç¤º"></a>å·®å¼‚ç»“æœå±•ç¤º</h2><blockquote><p>react-diff-viewåº“ï¼š ç±»ä¼¼Gitå·®å¼‚æ¯”è¾ƒçš„å±•ç¤ºï¼Œèƒ½å¤Ÿå°†ç”Ÿæˆçš„diffå±•ç¤ºæˆReactç»„ä»¶ã€‚<br>â€œreact-diff-viewâ€ vs â€œreact-diff-viewerâ€<br>  éƒ½å¯ä»¥ä»¥æ»¡è¶³å¯¹æ¯”çš„éœ€æ±‚ï¼ˆä»…å±•ç¤ºï¼‰<br>  å‰è€…å¯æ‹“å±•æ€§å¼ºï¼Œåç»­å¯æ‹“å±•è¯„è®ºç­‰åŠŸèƒ½â€¦<br>  ä½†åè€…ç”±äºé«˜åº¦å°è£…ï¼Œæ— æ³•é«˜åº¦å®šåˆ¶åŒ–éœ€æ±‚ï¼ˆä¾‹å¦‚å½“ä¸¤è¾¹å®Œå…¨ä¸€è‡´ä¹Ÿå±•ç¤ºå°±æ— æ³•å®ç°ï¼‰ã€‚</p></blockquote><p>å°†è®¡ç®—ç»“æœå¤„ç†æˆ<a href="https://www.npmjs.com/package/react-diff-view">react-diff-view</a>èƒ½æ”¯æŒçš„æ ¼å¼è¿›è¡Œå±•ç¤ºã€‚</p><h3 id="a-æ£€æŸ¥ä¸€è‡´æ€§"><a href="#a-æ£€æŸ¥ä¸€è‡´æ€§" class="headerlink" title="a.æ£€æŸ¥ä¸€è‡´æ€§"></a>a.æ£€æŸ¥ä¸€è‡´æ€§</h3><p>å¦‚æœ <code>diffLines()</code> è¿”å›ç©ºæ•°ç»„ï¼ˆå³ä¸¤æ®µä»£ç ä¸€è‡´ï¼‰ï¼ŒæŒ‰ç…§unidiffç”Ÿæˆçš„æ¨¡æ¿æ ¼å¼æ„é€ ä¸€ä¸ªdiffè¾“å‡ºï¼Œè¿™æ ·å³ä½¿æ²¡æœ‰å·®å¼‚ï¼Œä¹Ÿèƒ½å±•ç¤ºå‡ºæ‰€æœ‰ä»£ç è¡Œã€‚</p><h3 id="b-æŠ˜å æœªå˜æ›´è¡Œ"><a href="#b-æŠ˜å æœªå˜æ›´è¡Œ" class="headerlink" title="b.æŠ˜å æœªå˜æ›´è¡Œ"></a>b.æŠ˜å æœªå˜æ›´è¡Œ</h3><p>åœ¨ç”Ÿæˆçš„diffå±•ç¤ºç»„ä»¶ä¸­ï¼Œå¦‚æœæœªå˜æ›´çš„è¡Œè¶…è¿‡10è¡Œï¼Œå¯ä»¥åˆ©ç”¨ <code>react-diff-view</code> æä¾›çš„æŠ˜å åŠŸèƒ½ï¼ˆæˆ–è‡ªå®šä¹‰é€»è¾‘ï¼‰è¿›è¡ŒæŠ˜å æ˜¾ç¤ºã€‚</p><h1 id="åº“ç›¸å…³æ–¹æ³•"><a href="#åº“ç›¸å…³æ–¹æ³•" class="headerlink" title="åº“ç›¸å…³æ–¹æ³•"></a>åº“ç›¸å…³æ–¹æ³•</h1><p>ä»…åˆ—ä¸¾unidiffå’Œreact-diff-viewä½¿ç”¨åˆ°çš„ä¸€äº›å…³é”®æ–¹æ³•ï¼Œè¯¦ç»†è¯·ç§»æ­¥å®˜ç½‘<br><img src='/img/article6/article6_npm.jpg' ></p><h1 id="ä»£ç å®ç°åŠè§£æ"><a href="#ä»£ç å®ç°åŠè§£æ" class="headerlink" title="ä»£ç å®ç°åŠè§£æ"></a>ä»£ç å®ç°åŠè§£æ</h1><p>tipsï¼šçœç•¥æ ·å¼éƒ¨åˆ†ï¼Œéå®Œæ•´ä»£ç ï¼Œå…³æ³¨ä¸»è¦é€»è¾‘ï¼</p><h2 id="ä¸»ç»„ä»¶"><a href="#ä¸»ç»„ä»¶" class="headerlink" title="ä¸»ç»„ä»¶"></a>ä¸»ç»„ä»¶</h2><p>ç›®çš„ï¼šæ¥æ”¶æ–°æ—§stringå’Œtitleï¼Œunidiff è®¡ç®—å·®å¼‚(<code>diffLines</code>)+æ ¼å¼åŒ–(<code>formatLines</code>)ï¼Œä¼ é€’ç»™ <code>DiffCode</code> ç»„ä»¶è¿›è¡Œæ¸²æŸ“ã€‚</p><div class="note primary simple"><p>ä»¥ä¸Šè¿°caseä¸¾ä¾‹ï¼ŒdiffLineså®é™…ä¼ å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">diffLines(</span><br><span class="line">  <span class="string">&quot;test1\nç¬¬ä¸€è¡Œ\nä¸ä¸€æ ·å•¦â€”â€”â€”â€”\nbonjour\nje suis coucou\n&quot;</span>,</span><br><span class="line">  <span class="string">&quot;newString&quot;</span>: <span class="string">&quot;test1\nç¬¬ä¸€è¡Œ\nä¸ä¸€æ ·å•¦â€”â€”â€”â€”\nhello\ni am coucou&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>diffLinesè¾“å‡ºç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test1\nç¬¬ä¸€è¡Œ\nä¸ä¸€æ ·å•¦â€”â€”â€”â€”\n&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;removed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bonjour\nje suis coucou\n&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;added&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hello\ni am coucou&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>å†å¯¹ç»“æœè¿›è¡ŒformatLinesï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--- a</span><br><span class="line">+++ b</span><br><span class="line">@@ <span class="number">-1</span><span class="punctuation">,</span><span class="number">5</span> +<span class="number">1</span><span class="punctuation">,</span><span class="number">5</span> @@</span><br><span class="line"> test1</span><br><span class="line"> ç¬¬ä¸€è¡Œ</span><br><span class="line"> ä¸ä¸€æ ·å•¦â€”â€”â€”â€”</span><br><span class="line">-bonjour</span><br><span class="line">-je suis coucou</span><br><span class="line">+hello</span><br><span class="line">+i am coucou </span><br></pre></td></tr></table></figure></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; formatLines, diffLines &#125; <span class="keyword">from</span> <span class="string">&#x27;unidiff&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; parseDiff &#125; <span class="keyword">from</span> <span class="string">&#x27;react-diff-view&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> (&#123; oldString, newString &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> diffText = <span class="title function_">useMemo</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">formatLines</span>(<span class="title function_">diffLines</span>(oldString, newString), &#123; <span class="attr">context</span>: <span class="number">5</span> &#125;),</span><br><span class="line">    [oldString, newString],</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">const</span> [file] = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> <span class="title function_">parseDiff</span>(diffText), [diffText])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;file?.hunks?.length &gt; 0 ? (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">DiffCode</span> <span class="attr">file</span>=<span class="string">&#123;file&#125;</span> <span class="attr">oldString</span>=<span class="string">&#123;oldString&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      ) : (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>æœ¬æ¬¡æš‚æ— å˜æ›´<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DiffCode-ç»„ä»¶"><a href="#DiffCode-ç»„ä»¶" class="headerlink" title="DiffCode ç»„ä»¶"></a>DiffCode ç»„ä»¶</h2><p><b>ç›®çš„ï¼š</b><br>ä¼ é€’å¤„ç†åçš„ hunksï¼Œ å¹¶åœ¨ react-diff-viewæä¾›çš„ Diff ç»„ä»¶å±•ç¤ºã€‚</p><ul><li><code>renderHunk</code> å‡½æ•°ï¼šè´Ÿè´£æ¸²æŸ“æ¯ä¸€ä¸ª hunkï¼ˆå·®å¼‚å—ï¼‰ï¼Œåˆ†3partï¼š hunkæœ¬è¡Œï¼Œè¯¥hunkå‰éƒ¨ï¼Œè¯¥hunkå°¾éƒ¨ï¼Œå‰åéƒ¨æ§åˆ¶å·®å¼‚å—çš„æŠ˜å å’Œå±•å¼€ã€‚</li><li><code>UnfoldCollapsed</code> è‡ªå®šä¹‰ç»„ä»¶ï¼šè¿™æ˜¯æŠ˜å &#x2F;å±•å¼€çš„æ§åˆ¶å™¨ç»„ä»¶ï¼Œæä¾›äº¤äº’ä½“éªŒï¼Œå…è®¸ç”¨æˆ·æ ¹æ®éœ€è¦å±•å¼€æˆ–æŠ˜å å˜æ›´éƒ¨åˆ†ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Diff</span>, <span class="title class_">Hunk</span>, useSourceExpansion, useMinCollapsedLines &#125; <span class="keyword">from</span> <span class="string">&#x27;react-diff-view&#x27;</span></span><br><span class="line"><span class="keyword">import</span> useEnhance <span class="keyword">from</span> <span class="string">&#x27;./useEnhance&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getHunks <span class="keyword">from</span> <span class="string">&#x27;./getHunks&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">DiffCode</span> = (<span class="params">&#123; file, oldString &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> realhunks = <span class="title function_">getHunks</span>(file, oldString)</span><br><span class="line">  <span class="keyword">const</span> &#123; expandRange, hunks &#125; = <span class="title function_">useEnhance</span>(realhunks, oldString)</span><br><span class="line">  <span class="keyword">const</span> linesCount = oldString ? oldString.<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>).<span class="property">length</span> : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">renderHunk</span> = (<span class="params">children, hunk, i, hunks</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// è¯¥hunkå‰æŠ˜å å—/æ— å†…å®¹</span></span><br><span class="line">    <span class="keyword">const</span> previousDecorationElement = ...</span><br><span class="line">    children.<span class="title function_">push</span>(previousDecorationElement)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hunkElement = <span class="language-xml"><span class="tag">&lt;<span class="name">Hunk</span> <span class="attr">key</span>=<span class="string">&#123;</span>`<span class="attr">hunk-</span>$&#123;<span class="attr">hunk.content</span>&#125;`&#125; <span class="attr">hunk</span>=<span class="string">&#123;hunk&#125;</span> /&gt;</span></span></span><br><span class="line">    children.<span class="title function_">push</span>(hunkElement)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i === hunks.<span class="property">length</span> - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// è¯¥hunkåæŠ˜å å—/æ— å†…å®¹</span></span><br><span class="line">      children.<span class="title function_">push</span>(unfoldTailElement)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> children</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Diff</span> <span class="attr">viewType</span>=<span class="string">&quot;split&quot;</span> <span class="attr">diffType</span>=<span class="string">&#123;file.type&#125;</span> <span class="attr">hunks</span>=<span class="string">&#123;hunks&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;</span></span><br><span class="line"><span class="language-xml">        hunks =&gt; hunks.reduce(renderHunk, [])</span></span><br><span class="line"><span class="language-xml">      &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Diff</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getHunks"><a href="#getHunks" class="headerlink" title="getHunks"></a>getHunks</h3><div class="note primary modern"><p><b>hunks çš„ç»“æ„å’Œå†…å®¹</b><br><code>parseDiff</code>ç”Ÿæˆçš„å·®å¼‚æ•°ç»„ï¼š<code>hunks</code>ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªå·®å¼‚å—ï¼ˆhunkï¼‰ï¼Œæ¯ä¸ªå·®å¼‚å— (hunk) åŒ…å«äº†ä¸€ç»„å˜æ›´è¡Œï¼ˆchangesï¼‰ã€‚<br>hunk çš„æ•°æ®ç»“æ„é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const hunk = <span class="punctuation">&#123;</span></span><br><span class="line">  changes<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      content<span class="punctuation">:</span> &#x27;code line&#x27;<span class="punctuation">,</span></span><br><span class="line">      isNormal<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="comment">// æ­£å¸¸è¡Œï¼Œä¸æ˜¯å˜æ›´</span></span><br><span class="line">      newLineNumber<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      oldLineNumber<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      type<span class="punctuation">:</span> &#x27;normal&#x27;<span class="punctuation">,</span> <span class="comment">// &#x27;normal&#x27; è¡¨ç¤ºæ²¡æœ‰å˜åŠ¨ï¼Œ&#x27;add&#x27; è¡¨ç¤ºæ–°å¢ï¼Œ&#x27;del&#x27; è¡¨ç¤ºåˆ é™¤</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  newLines<span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="comment">// å˜æ›´çš„è¡Œæ•°</span></span><br><span class="line">  oldLines<span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="comment">// æ—§çš„ä»£ç è¡Œæ•°</span></span><br><span class="line">  newStart<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>  <span class="comment">// æ–°æ–‡ä»¶ä¸­å¼€å§‹çš„è¡Œå·</span></span><br><span class="line">  oldStart<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>  <span class="comment">// æ—§æ–‡ä»¶ä¸­å¼€å§‹çš„è¡Œå·</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getHunks</span> = (<span class="params">file, oldString</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> realhunks = []</span><br><span class="line">  <span class="keyword">const</span> hunks = file?.<span class="property">hunks</span> || []</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (hunks.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// ç•¥ï¼šå½“å®Œå…¨æ²¡æœ‰diffæ—¶ï¼Œæ‰‹å·¥æ„é€ ä¸€ä¸ªhunks ä»¥æ”¯æŒå·¦å³å±•ç¤º</span></span><br><span class="line">    <span class="keyword">const</span> changes = ....</span><br><span class="line">    realhunks = [</span><br><span class="line">      &#123;</span><br><span class="line">        changes,</span><br><span class="line">        <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">isPlain</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">newLines</span>: linesCount,</span><br><span class="line">        <span class="attr">oldLines</span>: linesCount,</span><br><span class="line">        <span class="attr">newStart</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">oldStart</span>: <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    realhunks = hunks</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> realhunks</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useEnhance"><a href="#useEnhance" class="headerlink" title="useEnhance"></a>useEnhance</h3><ul><li>useSourceExpansionï¼šè¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„hookï¼Œç”¨äºæ”¯æŒæŠ˜å å’Œå±•å¼€çš„è¡Œä¸ºï¼Œè¿”å›çš„æ˜¯å·²æ‰©å±•çš„ hunks å’Œä¸€ä¸ªæ§åˆ¶å±•å¼€çš„å‡½æ•° expandRangeã€‚</li><li>useMinCollapsedLinesï¼šç”¨äºæ§åˆ¶æœ€å°æŠ˜å è¡Œæ•°ï¼ˆä¾‹å¦‚5è¡Œï¼‰ï¼Œå¯¹æŠ˜å çš„ hunks è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</li></ul><p>é€šè¿‡ç»„åˆè¿™ä¸¤ä¸ªè‡ªå®šä¹‰hookï¼Œå¢å¼ºäº†å·®å¼‚å±•ç¤ºçš„äº¤äº’ä½“éªŒï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿåœ¨å·®å¼‚å¾ˆå¤šæ—¶ä¿æŒæ¸…æ™°çš„è§†å›¾ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useSourceExpansion, useMinCollapsedLines &#125; <span class="keyword">from</span> <span class="string">&#x27;react-diff-view&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useEnhance</span> = (<span class="params">hunks, oldSource</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [hunksWithSourceExpanded, expandRange] = <span class="title function_">useSourceExpansion</span>(hunks, oldSource)</span><br><span class="line">  <span class="keyword">const</span> hunksWithMinLinesCollapsed = <span class="title function_">useMinCollapsedLines</span>(<span class="number">5</span>, hunksWithSourceExpanded, oldSource)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    expandRange,</span><br><span class="line">    <span class="attr">hunks</span>: hunksWithMinLinesCollapsed,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> é¡¹ç›®å®æˆ˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Diff: å¯åˆ å‡ã€æœ‰é¡ºåºçš„å¯¹è±¡æ•°ç»„</title>
      <link href="/2024/08/03/article7/"/>
      <url>/2024/08/03/article7/</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>åœ¨æ—¥å¸¸ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¯¹ä¸€ä¸ªâ€œå¯¹è±¡æ•°ç»„â€è¿›è¡Œæ–°æ—§ç‰ˆæœ¬çš„æ¯”è¾ƒã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>å­—æ®µæœ‰é¡ºåº</li><li>å¯ä»»æ„å¢åˆ </li><li>keyï¼šæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†çš„é”®ï¼Œæ¯”å¦‚idï¼Œç”¨æ¥å‡†ç¡®åŒ¹é…å¯¹è±¡ã€‚</li></ul><h1 id="æ€è·¯åŠå®ç°"><a href="#æ€è·¯åŠå®ç°" class="headerlink" title="æ€è·¯åŠå®ç°"></a>æ€è·¯åŠå®ç°</h1><p>æ ¸å¿ƒï¼šè§£å†³å¦‚ä½•éå†å¯¹è±¡æ•°ç»„ï¼Ÿ<br>è¿™é‡Œå°†keyåˆ†å¼º&#x2F;å¼±ä¸¤ç§æƒ…å†µè¿›è¡Œè®¨è®ºï¼š</p><h2 id="å¼ºkey"><a href="#å¼ºkey" class="headerlink" title="å¼ºkey"></a>å¼ºkey</h2><p>å¼ºkeyï¼Œå³èµ‹ç»™keyçš„å€¼ä¸ä¼šå˜åŒ–ã€‚</p><blockquote><p>case:<br>  å¯ä»»æ„æ‹–æ‹½&#x2F;ä¿®æ”¹åç§°çš„æ–‡ä»¶ç›®å½•ï¼Œ<br>  keyï¼šç›®å½•&#x2F;æ–‡ä»¶id</p></blockquote><p>å¯¹äºä»»æ„ä¸¤ä¸ªå¯¹è±¡æ•°ç»„ï¼Œå·®å¼‚è®¡ç®—å°†æµç¨‹æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹é˜¶æ®µï¼š<br>(1) å…ˆæŒ‰æ—§æ•°ç»„é¡ºåºå¤„ç†æ‰€æœ‰å…ƒç´ ï¼ˆåˆ é™¤&#x2F;å˜æ›´&#x2F;æ­£å¸¸ï¼‰<br>(2) å†å¤„ç†æ–°æ•°ç»„ä¸­æ–°å¢çš„å…ƒç´ </p><ul><li>åˆ é™¤é¡¹ ï¼šç›´æ¥éå†æ—§æ•°ç»„ <code>leftArr</code>ï¼Œè‹¥å¯¹åº”é”®åœ¨ <code>mapB</code> ä¸­ä¸å­˜åœ¨ï¼Œåˆ™æ ‡è®°ä¸ºåˆ é™¤ã€‚</li><li>å˜æ›´&#x2F;æ­£å¸¸é¡¹ ï¼šè‹¥é”®å­˜åœ¨åˆ™è¿›è¡Œå€¼æ¯”è¾ƒï¼Œé€šè¿‡ <code>handleValue</code> å¤„ç†ååˆ¤æ–­ç±»å‹ã€‚</li><li>æ–°å¢é¡¹ ï¼šéå†æ–°æ•°ç»„ <code>mapB</code> ä¸­å‰©ä½™æœªè¢«å¤„ç†çš„é¡¹ï¼ˆå³ä¸åœ¨æ—§æ•°ç»„ä¸­çš„é”®ï¼‰ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleDiffDataStrictOrder</span> = (<span class="params">oldValue, newValue, rowKey, handleValue</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// è¿‡æ»¤ç©ºå¯¹è±¡çš„è¾…åŠ©å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getArr</span> = (<span class="params">arr</span>) =&gt; </span><br><span class="line">    arr &amp;&amp; <span class="title class_">Array</span>.<span class="title function_">isArray</span>(arr) </span><br><span class="line">      ? arr.<span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(e).<span class="property">length</span> &gt; <span class="number">0</span>) </span><br><span class="line">      : []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> leftArr = <span class="title function_">getArr</span>(oldValue)  <span class="comment">// è¿‡æ»¤åçš„æ—§æ•°ç»„</span></span><br><span class="line">  <span class="keyword">const</span> rightArr = <span class="title function_">getArr</span>(newValue) <span class="comment">// è¿‡æ»¤åçš„æ–°æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†åŸå§‹æ•°ç»„è½¬æ¢ä¸º Mapï¼Œä¾¿äºå¿«é€ŸæŸ¥æ‰¾å’Œå¯¹æ¯”</span></span><br><span class="line">  <span class="keyword">const</span> mapA = <span class="keyword">new</span> <span class="title class_">Map</span>(leftArr.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> [item[rowKey], item]))</span><br><span class="line">  <span class="keyword">const</span> mapB = <span class="keyword">new</span> <span class="title class_">Map</span>(rightArr.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> [item[rowKey], item]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. å¤„ç†æ—§æ•°ç»„ä¸­çš„å…ƒç´ ï¼ˆåˆ é™¤æˆ–å˜æ›´/æ­£å¸¸ï¼‰</span></span><br><span class="line">  leftArr.<span class="title function_">forEach</span>(<span class="function">(<span class="params">leftItem</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = leftItem[rowKey];</span><br><span class="line">    <span class="keyword">const</span> rightItem = mapB.<span class="title function_">get</span>(key); <span class="comment">// æ ¹æ® key æŸ¥æ‰¾æ–°æ•°ç»„çš„å¯¹åº”é¡¹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!rightItem) &#123;</span><br><span class="line">      <span class="comment">// æ—§æ•°ç»„å­˜åœ¨ï¼Œæ–°æ•°ç»„ä¸å­˜åœ¨ â†’ åˆ é™¤é¡¹</span></span><br><span class="line">      result.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">oldValue</span>: <span class="title function_">handleValue</span>(leftItem),</span><br><span class="line">        <span class="attr">newValue</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        key,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;delete&#x27;</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å­˜åœ¨å¯¹åº”é¡¹ â†’ æ¯”è¾ƒå€¼</span></span><br><span class="line">      <span class="keyword">const</span> leftValue = <span class="title function_">handleValue</span>(leftItem);</span><br><span class="line">      <span class="keyword">const</span> rightValue = <span class="title function_">handleValue</span>(rightItem);</span><br><span class="line">      <span class="keyword">const</span> type = leftValue === rightValue ? <span class="string">&#x27;normal&#x27;</span> : <span class="string">&#x27;update&#x27;</span>;</span><br><span class="line">      result.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">oldValue</span>: leftValue,</span><br><span class="line">        <span class="attr">newValue</span>: rightValue,</span><br><span class="line">        key,</span><br><span class="line">        type,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// ä»æ–°æ•°ç»„çš„ Map ä¸­åˆ é™¤å·²å¤„ç†çš„ keyï¼Œé¿å…é‡å¤å¤„ç†</span></span><br><span class="line">      mapB.<span class="title function_">delete</span>(key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. å¤„ç†æ–°æ•°ç»„ä¸­å‰©ä½™çš„æ–°å¢é¡¹</span></span><br><span class="line">  <span class="keyword">const</span> addedItems = <span class="title class_">Array</span>.<span class="title function_">from</span>(mapB.<span class="title function_">values</span>())</span><br><span class="line">  addedItems.<span class="title function_">forEach</span>(<span class="function">(<span class="params">rightItem</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = rightItem[rowKey];</span><br><span class="line">    result.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">oldValue</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">newValue</span>: <span class="title function_">handleValue</span>(rightItem),</span><br><span class="line">      key,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;add&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note modern orange flat"><p>é€šè¿‡ Map å•æ¬¡æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚<br>Map ä¼šä¿ç•™æ’å…¥é¡ºåºï¼Œå› æ­¤ <code>Array.from(mapB.values())</code> ä¼šæŒ‰æ–°æ•°ç»„ <code>rightArr</code> çš„åŸå§‹é¡ºåºè¿”å›æ–°å¢é¡¹ã€‚</p></div><h2 id="å¼±key"><a href="#å¼±key" class="headerlink" title="å¼±key"></a>å¼±key</h2><p>å¼±keyï¼Œå³èµ‹ç»™keyçš„å€¼å¯èƒ½è¢«ä¿®æ”¹ï¼Œå‘ç”Ÿå˜åŒ–ã€‚</p><blockquote><p>caseï¼š<br>åˆ›å»ºä¸€å¼ æ•°æ®è¡¨ï¼Œå¯ä»»æ„å¢åˆ ï¼Œæ¯ä¸ªå­—æ®µçš„åºå·ä¼šæ ¹æ®æ‹–æ‹½é‡æ–°ç”Ÿæˆã€‚<br>keyï¼šå­—æ®µåç§°ï¼Œä½†å­—æ®µåç§°å¯ä»¥ä¿®æ”¹<br>ä¾‹å¦‚<a href="/2024/06/29/article5/">å¯æ‹–æ‹½çš„å¤šå±‚çº§è¡¨æ ¼</a><br><img src="/img/article5/article5-2.gif" style="width: 100%;"></p></blockquote><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å·¦ä¾§æ•°æ®ï¼ˆæ—§æ•°æ®ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> oldData = [</span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name1&#x27;</span>, <span class="attr">value</span>: <span class="number">1</span> &#125;,  <span class="comment">// å·¦key: name1</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name2&#x27;</span>, <span class="attr">value</span>: <span class="number">2</span> &#125;,  <span class="comment">// å·¦key: name2</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name3&#x27;</span>, <span class="attr">value</span>: <span class="number">3</span> &#125;,  <span class="comment">// å·¦key: name3</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name4&#x27;</span>, <span class="attr">value</span>: <span class="number">4</span> &#125;   <span class="comment">// å·¦key: name4</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å³ä¾§æ•°æ®ï¼ˆæ–°æ•°æ®ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> newData = [</span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name1&#x27;</span>, <span class="attr">value</span>: <span class="number">1</span> &#125;,    <span class="comment">// å³key: name1</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name2&#x27;</span>, <span class="attr">value</span>: <span class="number">2</span> &#125;,    <span class="comment">// å³key: name2</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name22&#x27;</span>, <span class="attr">value</span>: <span class="number">22</span> &#125;,  <span class="comment">// å³key: name22</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name3_1&#x27;</span>, <span class="attr">value</span>: <span class="number">31</span> &#125;, <span class="comment">// å³key: name3_1</span></span><br><span class="line">  &#123; <span class="attr">field</span>: <span class="string">&#x27;name5&#x27;</span>, <span class="attr">value</span>: <span class="number">5</span> &#125;     <span class="comment">// å³key: name5</span></span><br><span class="line">]</span><br><span class="line"><span class="comment">// äº¤é›†keys</span></span><br><span class="line"><span class="keyword">const</span> intersect = [<span class="string">&#x27;name1&#x27;</span>, <span class="string">&#x27;name2&#x27;</span>]</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><table><thead><tr><th>ç±»å‹</th><th>æ—§Key</th><th>æ–°Key</th><th>æ—§å€¼</th><th>æ–°å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>âœ… Normal</td><td>name1</td><td>name1</td><td>1</td><td>1</td><td>æœªå˜åŒ–çš„å­—æ®µ</td></tr><tr><td>âœ… Normal</td><td>name2</td><td>name2</td><td>2</td><td>2</td><td>æœªå˜åŒ–çš„å­—æ®µ</td></tr><tr><td>ğŸ”„ Update</td><td>name3</td><td>name22</td><td>3</td><td>22</td><td>å­—æ®µé‡å‘½åï¼ˆå¼±keyå˜æ›´ï¼‰</td></tr><tr><td>ğŸ”„ Delete</td><td>name4</td><td>name3_1</td><td>4</td><td>31</td><td>å­—æ®µé‡å‘½åï¼ˆå¼±keyå˜æ›´ï¼‰</td></tr><tr><td>â• Add</td><td>-</td><td>name5</td><td>-</td><td>5</td><td>æ–°æ•°æ®æ–°å¢å­—æ®µ</td></tr></tbody></table><p>ç¬¦å·è¯´æ˜ï¼š<br>âœ… Normal - æ— å˜åŒ–<br>ğŸ”„ Update - å­—æ®µæ›´æ–°&#x2F;é‡å‘½å âŒ Delete - å­—æ®µåˆ é™¤ â• Add - å­—æ®µæ–°å¢</p><p>whileå¾ªç¯éå†ä¸¤ä¸ªæ•°ç»„ï¼š </p><ul><li>å·¦keyä¸åœ¨äº¤é›† &amp;&amp; å³keyä¸åœ¨äº¤é›† â†’ Update</li><li>å·¦keyä¸å­˜åœ¨ï¼ˆæ—§æ•°ç»„å·²éå†ç»“æŸï¼‰ &amp;&amp; å³keyä¸åœ¨äº¤é›† â†’ Add</li><li>å·¦keyä¸åœ¨äº¤é›† &amp;&amp; ï¼ˆå³keyä¸å­˜åœ¨ || å³keyåœ¨äº¤é›†é‡Œï¼‰ â†’ Delete</li><li>åœ¨äº¤é›†ä¸­ï¼šæ­£å¸¸æ¯”è¾ƒå±æ€§ï¼Œä¸åŒUp â†’ dateï¼Œç›¸åŒ â†’ Normal</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleDiffData</span> = (<span class="params">oldValue, newValue, rowKey, handleValue</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// å¢å¼ºè¿‡æ»¤å‡½æ•°ï¼šè¿‡æ»¤æ— æ•ˆé¡¹å¹¶ç¡®ä¿åŒ…å«rowKey</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getValidArray</span> = (<span class="params">arr</span>) =&gt; </span><br><span class="line">    (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(arr) ? arr : [])</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> item &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(item).<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; item[rowKey]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æœ‰æ•ˆæ•°ç»„</span></span><br><span class="line">  <span class="keyword">const</span> leftArr = <span class="title function_">getValidArray</span>(oldValue);</span><br><span class="line">  <span class="keyword">const</span> rightArr = <span class="title function_">getValidArray</span>(newValue);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨Setä¼˜åŒ–äº¤é›†è®¡ç®—</span></span><br><span class="line">  <span class="keyword">const</span> leftKeys = <span class="keyword">new</span> <span class="title class_">Set</span>(leftArr.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> item[rowKey]));</span><br><span class="line">  <span class="keyword">const</span> rightKeys = <span class="keyword">new</span> <span class="title class_">Set</span>(rightArr.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> item[rowKey]));</span><br><span class="line">  <span class="keyword">const</span> intersectKeys = <span class="keyword">new</span> <span class="title class_">Set</span>([...leftKeys].<span class="title function_">filter</span>(<span class="function"><span class="params">key</span> =&gt;</span> rightKeys.<span class="title function_">has</span>(key)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = [];</span><br><span class="line">  <span class="keyword">let</span> leftIndex = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> rightIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºç»“æœé¡¹çš„è¾…åŠ©å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">createDiffEntry</span> = (<span class="params">type, oldItem, newItem, customKey</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> key = customKey || </span><br><span class="line">                (oldItem?.[rowKey] ?? newItem?.[rowKey]);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">oldValue</span>: oldItem ? <span class="title function_">handleValue</span>(oldItem) : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">newValue</span>: newItem ? <span class="title function_">handleValue</span>(newItem) : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">key</span>: key,</span><br><span class="line">      <span class="attr">type</span>: type</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (leftIndex &lt; leftArr.<span class="property">length</span> || rightIndex &lt; rightArr.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentLeft = leftArr[leftIndex];</span><br><span class="line">    <span class="keyword">const</span> currentRight = rightArr[rightIndex];</span><br><span class="line">    <span class="keyword">const</span> leftKey = currentLeft?.[rowKey];</span><br><span class="line">    <span class="keyword">const</span> rightKey = currentRight?.[rowKey];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> isLeftInIntersect = intersectKeys.<span class="title function_">has</span>(leftKey);</span><br><span class="line">    <span class="keyword">const</span> isRightInIntersect = intersectKeys.<span class="title function_">has</span>(rightKey);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æƒ…å†µ1: åˆ é™¤æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (leftKey &amp;&amp; !isLeftInIntersect &amp;&amp; (!rightKey || isRightInIntersect)) &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(<span class="title function_">createDiffEntry</span>(<span class="string">&#x27;delete&#x27;</span>, currentLeft, <span class="literal">null</span>));</span><br><span class="line">      leftIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æƒ…å†µ2: æ›´æ–°æ“ä½œ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (leftKey &amp;&amp; !isLeftInIntersect &amp;&amp; rightKey &amp;&amp; !isRightInIntersect) &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(<span class="title function_">createDiffEntry</span>(<span class="string">&#x27;update&#x27;</span>, currentLeft, currentRight, <span class="string">`<span class="subst">$&#123;leftKey&#125;</span>â†’<span class="subst">$&#123;rightKey&#125;</span>`</span>));</span><br><span class="line">      leftIndex++;</span><br><span class="line">      rightIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æƒ…å†µ3: æ–°å¢æ“ä½œ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!leftKey &amp;&amp; rightKey &amp;&amp; isRightInIntersect) &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(<span class="title function_">createDiffEntry</span>(<span class="string">&#x27;add&#x27;</span>, <span class="literal">null</span>, currentRight));</span><br><span class="line">      rightIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æƒ…å†µ4: å¸¸è§„æ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (currentLeft &amp;&amp; currentRight) &#123;</span><br><span class="line">        <span class="keyword">const</span> isSameValue = <span class="title function_">handleValue</span>(currentLeft) === <span class="title function_">handleValue</span>(currentRight);</span><br><span class="line">        result.<span class="title function_">push</span>(<span class="title function_">createDiffEntry</span>(</span><br><span class="line">          isSameValue ? <span class="string">&#x27;normal&#x27;</span> : <span class="string">&#x27;update&#x27;</span>,</span><br><span class="line">          currentLeft,</span><br><span class="line">          currentRight</span><br><span class="line">        ));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å®¹é”™å¤„ç†ï¼šå½“å•è¾¹å­˜åœ¨æ—¶ï¼ˆç†è®ºä¸Šä¸åº”è¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (currentLeft) &#123;</span><br><span class="line">          result.<span class="title function_">push</span>(<span class="title function_">createDiffEntry</span>(<span class="string">&#x27;delete&#x27;</span>, currentLeft, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (currentRight) &#123;</span><br><span class="line">          result.<span class="title function_">push</span>(<span class="title function_">createDiffEntry</span>(<span class="string">&#x27;add&#x27;</span>, <span class="literal">null</span>, currentRight));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      leftIndex++;</span><br><span class="line">      rightIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> é¡¹ç›®å®æˆ˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>antdå®ç°table+formå¤šå±‚çº§å­—æ®µçš„æ‹–æ‹½ã€æ–°å¢å’Œåˆ é™¤</title>
      <link href="/2024/06/29/article5/"/>
      <url>/2024/06/29/article5/</url>
      
        <content type="html"><![CDATA[<h1 id="æœ€ç»ˆå®ç°æ•ˆæœ"><a href="#æœ€ç»ˆå®ç°æ•ˆæœ" class="headerlink" title="æœ€ç»ˆå®ç°æ•ˆæœ"></a>æœ€ç»ˆå®ç°æ•ˆæœ</h1><ul><li>indexéœ€è¦æ ¹æ®å±‚çº§å…³ç³»å±•ç¤ºï¼Œå¦‚1ï¼Œ1.1, 2â€¦</li><li>å¯¹äºä»»æ„å­—æ®µç±»å‹æ”¯æŒæ–°å¢å¹³çº§å­—æ®µï¼Œå¯¹äºåµŒå¥—ç±»å‹æ”¯æŒæ–°å¢å­å­—æ®µ</li><li>æ”¯æŒåˆ é™¤ï¼Œå¯¹äºåµŒå¥—ç±»å‹ï¼Œåˆ é™¤çˆ¶å­—æ®µï¼Œå­å­—æ®µå…¨éƒ¨åˆ é™¤ï¼Œ</li></ul><img src="/img/article5/article5-1.jpg" style="width: 100%;"><ul><li>å¯¹äºåµŒå¥—ç±»å‹ï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¾§â€+&#x2F;-â€œæ”¶èµ·å­å­—æ®µ</li><li>å¯æ‹–æ‹½ï¼Œæ‹–æ‹½å®Œæˆåä¼šé‡æ–°æ›´æ–°indexå±•ç¤ºï¼Œå¯¹äºåµŒå¥—ç±»å‹ä¼šå°†æ‰€æœ‰å­å­—æ®µä¸€èµ·æ‹–æ‹½è¿‡å»</li></ul><img src="/img/article5/article5-2.gif" style="width: 100%;"><h2 id="step1-tableæ ‘å½¢æ•°æ®å±•ç¤º"><a href="#step1-tableæ ‘å½¢æ•°æ®å±•ç¤º" class="headerlink" title="step1 tableæ ‘å½¢æ•°æ®å±•ç¤º"></a>step1 tableæ ‘å½¢æ•°æ®å±•ç¤º</h2><p><a href="https://ant-design.antgroup.com/components/table-cn#table-demo-tree-data">antd-æ ‘å½¢æ•°æ®table</a></p><blockquote><p>antdå®˜ç½‘ï¼šè¡¨æ ¼æ”¯æŒæ ‘å½¢æ•°æ®çš„å±•ç¤ºï¼Œå½“æ•°æ®ä¸­æœ‰ <code>children</code> å­—æ®µæ—¶ä¼šè‡ªåŠ¨å±•ç¤ºä¸ºæ ‘å½¢è¡¨æ ¼ï¼Œå¯ä»¥å±•å¼€æ”¶èµ·å­å­—æ®µ</p><img src="/img/article5/article5-3.jpg" style="width: 100%;"></blockquote><h2 id="step2-æ„é€ æ•°æ®ç»“æ„"><a href="#step2-æ„é€ æ•°æ®ç»“æ„" class="headerlink" title="step2 æ„é€ æ•°æ®ç»“æ„"></a>step2 æ„é€ æ•°æ®ç»“æ„</h2><h3 id="åµŒå¥—ç»“æ„"><a href="#åµŒå¥—ç»“æ„" class="headerlink" title="åµŒå¥—ç»“æ„"></a>åµŒå¥—ç»“æ„</h3><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªå¸¦æœ‰childrençš„åµŒå¥—å¯¹è±¡æ•°ç»„ã€‚<br>ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œæˆ‘ä»¬çš„æ•°æ®ç»“æ„åº”æ˜¯ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name1çš„å­name1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name1.1çš„å­_name1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><h3 id="keyçš„è®¾ç½®"><a href="#keyçš„è®¾ç½®" class="headerlink" title="keyçš„è®¾ç½®"></a>keyçš„è®¾ç½®</h3><p>éœ€æ±‚ä¸­æ”¯æŒå¢åˆ æ“ä½œï¼Œä¾èµ–keyå€¼æ¥è¿›è¡Œè®¡ç®—ï¼Œå®ƒä»£è¡¨ç€å½“å‰è¡Œæ•°æ®åœ¨æ•´ä¸ªæ•°æ®ä¸­çš„ç´¢å¼•ä½ç½®ã€‚<br>è€ƒè™‘ä½¿ç”¨0, 0.0, 0.0.0çš„æ–¹å¼æ¥è®¾ç½®keyï¼Œè¿™æ ·åœ¨æ–°å¢å’Œåˆ é™¤æ—¶å¯ä»¥æ–¹ä¾¿çš„è®¡ç®—å‡ºæ–°çš„keyå€¼ã€‚<br>æ•°æ®ç»“æ„æ›´æ–°ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name1çš„å­name1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name1.1çš„å­_name1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            ...</span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><h2 id="step3-å®ç°å¢ã€åˆ ã€æ‹–æ‹½"><a href="#step3-å®ç°å¢ã€åˆ ã€æ‹–æ‹½" class="headerlink" title="step3 å®ç°å¢ã€åˆ ã€æ‹–æ‹½"></a>step3 å®ç°å¢ã€åˆ ã€æ‹–æ‹½</h2><h3 id="å…¬å…±æ–¹æ³•"><a href="#å…¬å…±æ–¹æ³•" class="headerlink" title="å…¬å…±æ–¹æ³•"></a>å…¬å…±æ–¹æ³•</h3><h4 id="æ›´æ–°ç´¢å¼•"><a href="#æ›´æ–°ç´¢å¼•" class="headerlink" title="æ›´æ–°ç´¢å¼•"></a>æ›´æ–°ç´¢å¼•</h4><p><code>updateKey</code>:<br>é€’å½’åœ°éå†æ•°æ®ç»“æ„ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆæ­£ç¡®çš„å±‚çº§ç´¢å¼• <code>key</code>ã€‚<br>å®ƒé€šè¿‡é€’å½’æ–¹å¼å¤„ç†åµŒå¥—æ•°æ®ï¼Œç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹çš„ key ä¸å®ƒåœ¨æ ‘å½¢ç»“æ„ä¸­çš„ä½ç½®ç›¸å¯¹åº”ã€‚</p><p>å‡½æ•°å‚æ•°ï¼š<br><code>originData</code>: åŸå§‹æ•°æ®ï¼ŒåŒ…å«äº†éœ€è¦æ›´æ–°çš„å­—æ®µã€‚è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯èƒ½åŒ…å«å¹³çº§æˆ–åµŒå¥—çš„æ•°æ®ã€‚<br><code>fatherIndex</code>: å½“å‰æ•°æ®é¡¹çš„çˆ¶çº§ç´¢å¼•ã€‚å¦‚æœæ˜¯æœ€å¤–å±‚çš„æ•°æ®ï¼Œçˆ¶çº§ç´¢å¼•ä¸ºç©ºå­—ç¬¦ä¸² â€˜â€™ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">updateIndexesRecursively</span> = (<span class="params">originData, fatherIndex = <span class="string">&#x27;&#x27;</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> originData) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœçˆ¶çº§ç´¢å¼•ä¸ºç©ºï¼Œè¯´æ˜æ˜¯æœ€å¤–å±‚æ•°æ®ï¼Œç›´æ¥è®¾ç½®ä¸ºå½“å‰çš„ indexï¼Œå¦åˆ™å°†çˆ¶çº§ç´¢å¼•å’Œå½“å‰ç´¢å¼•æ‹¼æ¥</span></span><br><span class="line">    item.<span class="property">key</span> = fatherIndex === <span class="string">&#x27;&#x27;</span> ? index : <span class="string">`<span class="subst">$&#123;fatherIndex&#125;</span>.<span class="subst">$&#123;index&#125;</span>`</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰é¡¹æœ‰å­é¡¹ï¼Œé€’å½’å¤„ç†å­é¡¹</span></span><br><span class="line">    <span class="keyword">if</span> (item?.<span class="property">children</span>) &#123;</span><br><span class="line">      <span class="title function_">updateIndexesRecursively</span>(item.<span class="property">children</span>, item.<span class="property">key</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    index = (<span class="title class_">Number</span>(index) + <span class="number">1</span>).<span class="title function_">toString</span>() <span class="comment">// æ¯æ¬¡å¾ªç¯æ—¶ç´¢å¼•å¢åŠ </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°å±•å¼€çŠ¶æ€"><a href="#æ›´æ–°å±•å¼€çŠ¶æ€" class="headerlink" title="æ›´æ–°å±•å¼€çŠ¶æ€"></a>æ›´æ–°å±•å¼€çŠ¶æ€</h4><p><code>updateExpandedKeysAfterChangeï¼š</code><br>æ›´æ–°å±•å¼€çŠ¶æ€çš„ expandedKeysï¼Œå¹¶æ ¹æ®æ“ä½œç±»å‹ï¼ˆæ–°å¢æˆ–åˆ é™¤ï¼‰æ¥è°ƒæ•´ <code>expandedKeys</code> æ•°ç»„ä¸­æ¯ä¸ªé”®çš„å±‚çº§ã€‚</p><ol><li>æ–°å¢ï¼šå°†å¹³çº§èŠ‚ç‚¹çš„ key å€¼åŠ  1ï¼Œç¡®ä¿æ–°å¢èŠ‚ç‚¹çš„å±•å¼€çŠ¶æ€æ­£ç¡®ã€‚</li><li>åˆ é™¤ï¼šåˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œå°†ç›¸å…³èŠ‚ç‚¹çš„å±•å¼€çŠ¶æ€ä» expandedKeys ä¸­å‰”é™¤ã€‚</li><li>é€’å½’å¤„ç† expandedKeys æ•°ç»„ï¼Œè°ƒæ•´æ¯ä¸ª key å¯¹åº”çš„å±‚çº§ã€‚</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">updateExpandedKeysAfterChange</span> = (<span class="params">currentKey, operationType</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> updatedExpandedKeys = <span class="title function_">cloneDeep</span>(expandedKeys) <span class="comment">// å…‹éš†ä¸€ä»½å½“å‰çš„å±•å¼€çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ for å¾ªç¯éå† expandedKeys æ•°ç»„</span></span><br><span class="line">  <span class="keyword">const</span> result = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> updatedExpandedKeys) &#123;</span><br><span class="line">    <span class="keyword">let</span> keyParts = key.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>) <span class="comment">// å½“å‰å±•å¼€çš„ key</span></span><br><span class="line">    <span class="keyword">const</span> targetKeyParts = currentKey.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>) <span class="comment">// å½“å‰æ“ä½œçš„èŠ‚ç‚¹ key</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; targetKeyParts.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå½“å‰å±‚çº§çš„ key ä¸åŒ¹é…ï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">      <span class="keyword">if</span> (i &lt; targetKeyParts.<span class="property">length</span> - <span class="number">1</span> &amp;&amp; targetKeyParts[i] !== keyParts[i]) <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯åˆ é™¤æ“ä½œï¼Œåˆ é™¤åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        operationType === <span class="string">&#x27;remove&#x27;</span> &amp;&amp;</span><br><span class="line">        i === targetKeyParts.<span class="property">length</span> - <span class="number">1</span> &amp;&amp;</span><br><span class="line">        <span class="title class_">Number</span>(targetKeyParts[i]) === <span class="title class_">Number</span>(keyParts[i])</span><br><span class="line">      ) &#123;</span><br><span class="line">        keyParts = <span class="literal">null</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i === targetKeyParts.<span class="property">length</span> - <span class="number">1</span> &amp;&amp; <span class="title class_">Number</span>(targetKeyParts[i]) &lt; <span class="title class_">Number</span>(keyParts[i])) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ“ä½œçš„æ˜¯å½“å‰å±‚çº§çš„èŠ‚ç‚¹ï¼Œå¢åŠ æˆ–å‡å°‘èŠ‚ç‚¹çš„ç´¢å¼•å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (operationType === <span class="string">&#x27;add&#x27;</span>) &#123;</span><br><span class="line">          keyParts[i] = (<span class="title class_">Number</span>(keyParts[i]) + <span class="number">1</span>).<span class="title function_">toString</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (operationType === <span class="string">&#x27;remove&#x27;</span>) &#123;</span><br><span class="line">          keyParts[i] = (<span class="title class_">Number</span>(keyParts[i]) - <span class="number">1</span>).<span class="title function_">toString</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ keyParts ä¸æ˜¯ nullï¼Œè¯´æ˜è¯¥ key éœ€è¦ä¿ç•™</span></span><br><span class="line">    <span class="keyword">if</span> (keyParts) &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(keyParts.<span class="title function_">join</span>(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setExpandedKeys</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°å­—æ®µæ•°æ®"><a href="#æ›´æ–°å­—æ®µæ•°æ®" class="headerlink" title="æ›´æ–°å­—æ®µæ•°æ®"></a>æ›´æ–°å­—æ®µæ•°æ®</h4><p><code>updateFieldData</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">updateFieldData</span> = updatedList =&gt; &#123;</span><br><span class="line">  onChange &amp;&amp; <span class="title function_">onChange</span>(updatedList)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–°å¢"><a href="#æ–°å¢" class="headerlink" title="æ–°å¢"></a>æ–°å¢</h3><h4 id="åˆ›å»ºç©ºèŠ‚ç‚¹"><a href="#åˆ›å»ºç©ºèŠ‚ç‚¹" class="headerlink" title="åˆ›å»ºç©ºèŠ‚ç‚¹"></a>åˆ›å»ºç©ºèŠ‚ç‚¹</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºèŠ‚ç‚¹å¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createEmptyRow</span> = (<span class="params">key</span>) =&gt; (&#123;</span><br><span class="line">  <span class="attr">key</span>: key.<span class="title function_">toString</span>(),</span><br><span class="line">  <span class="attr">name</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">type</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="æ–°å¢å¹³çº§å­—æ®µ"><a href="#æ–°å¢å¹³çº§å­—æ®µ" class="headerlink" title="æ–°å¢å¹³çº§å­—æ®µ"></a>æ–°å¢å¹³çº§å­—æ®µ</h4><p><code>addSiblingRow</code>ï¼š é€’å½’éå†åˆ°ç´¢å¼•ä½ç½®ï¼Œåœ¨ç´¢å¼•ä½ç½®å¤„æ’å…¥ä¸€ç»„æ•°æ®ã€‚</p><ul><li>å¦‚æœæ˜¯æœ€å¤–å±‚èŠ‚ç‚¹ï¼Œç›´æ¥æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ ä¸Šè¿°å…¬å…±æ–¹æ³• æ¥æ›´æ–°çŠ¶æ€ã€‚</li><li>å¦‚æœæ˜¯åµŒå¥—èŠ‚ç‚¹ï¼Œé€’å½’è°ƒç”¨ <code>insertSiblingRowRecursively</code> ä»¥å¤„ç†åµŒå¥—ç»“æ„ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å¢å¹³çº§èŠ‚ç‚¹ï¼Œå‚æ•° currentKey ä¸ºå½“å‰èŠ‚ç‚¹çš„ key</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">addSiblingRow</span> = currentKey =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> clonedData = <span class="title function_">cloneDeep</span>(value) <span class="comment">// æ·±æ‹·è´æ•°æ®ï¼Œä»¥ç¡®ä¿è¡¨å•æ¸²æŸ“æ›´æ–°</span></span><br><span class="line">  <span class="keyword">const</span> keyArray = currentKey.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯æœ€å¤–å±‚èŠ‚ç‚¹ï¼Œç›´æ¥åœ¨å½“å‰ç´¢å¼•åæ’å…¥æ–°çš„æ•°æ®</span></span><br><span class="line">  <span class="keyword">if</span> (keyArray.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    clonedData.<span class="title function_">splice</span>(<span class="title class_">Number</span>(currentKey) + <span class="number">1</span>, <span class="number">0</span>, <span class="title function_">createEmptyRow</span>(<span class="title class_">Number</span>(currentKey) + <span class="number">1</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦åˆ™é€’å½’å¤„ç†åµŒå¥—çš„å¹³çº§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="title function_">insertSiblingRowRecursively</span>(clonedData, keyArray)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateIndexesRecursively</span>(clonedData, <span class="string">&#x27;&#x27;</span>) <span class="comment">// // æ›´æ–°ç´¢å¼•</span></span><br><span class="line">  <span class="title function_">updateExpandedKeysAfterChange</span>(currentKey, <span class="string">&#x27;add&#x27;</span>) <span class="comment">// æ›´æ–°å±•å¼€çŠ¶æ€</span></span><br><span class="line">  <span class="title function_">updateFieldData</span>(clonedData)  <span class="comment">// æ›´æ–°å­—æ®µæ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€’å½’éå†ï¼Œç›´åˆ°æ‰¾åˆ°éœ€è¦æ’å…¥çš„ä½ç½®ï¼Œç„¶ååœ¨è¯¥ä½ç½®æ’å…¥æ–°èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">// å‚æ•° originData ä¸ºåŸå§‹æ•°æ®ï¼ŒkeyArray ä¸ºç›®æ ‡èŠ‚ç‚¹çš„ç´¢å¼•è·¯å¾„</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">insertSiblingRowRecursively</span> = (<span class="params">originData, keyArray</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (keyArray.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    originData.<span class="title function_">splice</span>(<span class="title class_">Number</span>(keyArray[<span class="number">0</span>]) + <span class="number">1</span>, <span class="number">0</span>, <span class="title function_">createEmptyRow</span>(<span class="title class_">Number</span>(keyArray[<span class="number">0</span>]) + <span class="number">1</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> currentIndex = keyArray[<span class="number">0</span>]</span><br><span class="line">    keyArray.<span class="title function_">shift</span>()</span><br><span class="line">    <span class="title function_">insertSiblingRowRecursively</span>(originData[currentIndex].<span class="property">children</span>, keyArray)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–°å¢å­å­—æ®µ"><a href="#æ–°å¢å­å­—æ®µ" class="headerlink" title="æ–°å¢å­å­—æ®µ"></a>æ–°å¢å­å­—æ®µ</h4><p>éå† <code>keyArray</code>ï¼Œå®šä½åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ï¼Œç„¶åå°†æ–°å­å­—æ®µæ’å…¥åˆ°è¯¥èŠ‚ç‚¹çš„<code>children</code> æ•°ç»„ä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å¢å­èŠ‚ç‚¹ï¼Œå‚æ•° currentKey ä¸ºå½“å‰èŠ‚ç‚¹çš„ key</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">addChildrenRow</span> = currentKey =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> clonedData = <span class="title function_">cloneDeep</span>(value) <span class="comment">// æ·±æ‹·è´æ•°æ®ï¼Œä»¥ç¡®ä¿è¡¨å•æ¸²æŸ“æ›´æ–°</span></span><br><span class="line">  <span class="title function_">setExpandedKeys</span>(<span class="function"><span class="params">prev</span> =&gt;</span> [...<span class="keyword">new</span> <span class="title class_">Set</span>([...prev, currentKey])]) <span class="comment">// è®¾ç½®çˆ¶èŠ‚ç‚¹éœ€è¦å±•å¼€</span></span><br><span class="line">  <span class="title function_">addChildToNode</span>(clonedData, currentKey.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)) <span class="comment">// é€’å½’æ·»åŠ å­å­—æ®µ</span></span><br><span class="line">  <span class="title function_">updateExpandedKeysAfterChange</span>(currentKey, <span class="string">&#x27;&#x27;</span>) <span class="comment">// æ›´æ–°å±•å¼€çŠ¶æ€</span></span><br><span class="line">  <span class="title function_">updateFieldData</span>(clonedData)  <span class="comment">// æ›´æ–°å­—æ®µæ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€’å½’æ·»åŠ å­å­—æ®µï¼Œå‚æ•° originData ä¸ºåŸå§‹æ•°æ®ï¼ŒkeyArray ä¸ºç›®æ ‡èŠ‚ç‚¹çš„ç´¢å¼•è·¯å¾„</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">addChildToNode</span> = (<span class="params">originData, keyArray</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœ keyArray é•¿åº¦ä¸º 1ï¼Œè¯´æ˜å·²ç»åˆ°è¾¾æœ€åº•å±‚æ•°æ®</span></span><br><span class="line">  <span class="keyword">if</span> (keyArray.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> targetData = originData[keyArray[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¡®ä¿ç›®æ ‡æ•°æ®æœ‰ children æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (!targetData.<span class="property">children</span>) &#123;</span><br><span class="line">      targetData.<span class="property">children</span> = []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ children æ•°ç»„ä¸­æ’å…¥æ–°çš„å­èŠ‚ç‚¹</span></span><br><span class="line">    targetData.<span class="property">children</span>.<span class="title function_">push</span>(<span class="title function_">createEmptyRow</span>(<span class="string">&#x27;0&#x27;</span>)) <span class="comment">// åˆ›å»ºä¸€ä¸ªç©ºç™½å­èŠ‚ç‚¹</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> currentIndex = keyArray[<span class="number">0</span>]</span><br><span class="line">    keyArray.<span class="title function_">shift</span>() <span class="comment">// å¤„ç†ä¸‹ä¸€ä¸ªç´¢å¼•</span></span><br><span class="line">    <span class="title function_">addChildToNode</span>(originData[currentIndex].<span class="property">children</span>, keyArray)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h3><p><code>remove</code>ï¼šç”¨æ¥æ‰§è¡Œåˆ é™¤æ“ä½œã€‚æ ¹æ® <code>keyArray</code> çš„é•¿åº¦åˆ¤æ–­æ˜¯æœ€å¤–å±‚åˆ é™¤è¿˜æ˜¯é€’å½’åˆ é™¤ã€‚</p><ul><li>å¦‚æœæ˜¯æœ€å¤–å±‚èŠ‚ç‚¹ï¼Œç›´æ¥ä»åŸå§‹æ•°ç»„é‡Œspliceå‡ºå»ï¼Œ</li><li>å¦åˆ™é€’å½’æ‰¾åˆ°å½“å‰è¡Œçš„çˆ¶çº§æ•°æ®ï¼Œå°†ç›®æ ‡æ•°æ®ä»childrené‡Œé¢spliceå‡ºå»ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤æŒ‡å®škeyçš„æ•°æ®</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">remove</span> = key =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> newList = <span class="title function_">cloneDeep</span>(value)</span><br><span class="line">  <span class="keyword">const</span> keyArray = key.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (keyArray.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    newList.<span class="title function_">splice</span>(<span class="title class_">Number</span>(keyArray[<span class="number">0</span>]), <span class="number">1</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// é€’å½’åˆ é™¤</span></span><br><span class="line">    <span class="title function_">removeChildRecursively</span>(newList, keyArray)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">updateIndexesRecursively</span>(newList, <span class="string">&#x27;&#x27;</span>) <span class="comment">// æ¯æ¬¡æ•°æ®ä¿®æ”¹å®Œéœ€è¦é‡æ–°éå†ç”Ÿæˆç´¢å¼•key</span></span><br><span class="line">  <span class="title function_">updateFieldData</span>(newList)</span><br><span class="line">  <span class="title function_">updateExpandedKeysAfterChange</span>(key, <span class="string">&#x27;remove&#x27;</span>) <span class="comment">// æ¯æ¬¡åˆ é™¤åéœ€è¦æ›´æ–°å±•å¼€key</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€’å½’åˆ é™¤å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">removeChildRecursively</span> = (<span class="params">originData, keyArray</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> currentIndex = <span class="title class_">Number</span>(keyArray[<span class="number">0</span>])</span><br><span class="line">  keyArray.<span class="title function_">shift</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyArray.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    originData.<span class="title function_">splice</span>(currentIndex, <span class="number">1</span>) <span class="comment">// åˆ é™¤å½“å‰å±‚çš„å­èŠ‚ç‚¹</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ç»§ç»­é€’å½’è¿›å…¥å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="title function_">removeChildRecursively</span>(originData[currentIndex].<span class="property">children</span>, keyArray)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‹–æ‹½"><a href="#æ‹–æ‹½" class="headerlink" title="æ‹–æ‹½"></a>æ‹–æ‹½</h3><blockquote><p>å®ç°ï¼š<a href="https://github.com/clauderic/react-sortable-hoc">react-sortable-hoc</a> + Tableï¼Œä½†è¯¥åº“å·²ä¸å†ç»´æŠ¤ï¼Œåç»­æ¨èä½¿ç”¨ <a href="https://github.com/clauderic/dnd-kit">dnd-kit</a><br>ä»¥ä¸‹éå®Œæ•´ä»£ç ï¼Œä»…å±•ç¤ºæ‹–æ‹½çš„é‡è¦é€»è¾‘</p></blockquote><h4 id="æ‹–æ‹½ï¼šonSortEndé‡å†™"><a href="#æ‹–æ‹½ï¼šonSortEndé‡å†™" class="headerlink" title="æ‹–æ‹½ï¼šonSortEndé‡å†™"></a>æ‹–æ‹½ï¼šonSortEndé‡å†™</h4><p> ç›®æ ‡ï¼š</p><ul><li>äº¤æ¢æ•°ç»„ä¸­çš„ä¸¤é¡¹ï¼Œå³ oldIndex å’Œ newIndex å¯¹åº”çš„å±•å¼€é¡¹çš„é¡ºåºã€‚</li><li>ç¡®ä¿åœ¨äº¤æ¢åï¼Œå±•å¼€çŠ¶æ€ä¹Ÿèƒ½æ­£ç¡®æ›´æ–°</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">onSortEnd = <span class="function">(<span class="params">&#123; oldIndex, newIndex &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; dataSource, onChange, updateIndexesRecursively, updateExpandedKeys &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åªæœ‰æ‹–æ‹½ä½ç½®å‘ç”Ÿå˜åŒ–è¿›è¡Œå¤„ç†</span></span><br><span class="line">  <span class="keyword">if</span> (oldIndex !== newIndex) &#123;</span><br><span class="line">    <span class="keyword">const</span> newData = <span class="title function_">arrayMove</span>([...dataSource], oldIndex, newIndex); <span class="comment">//// æ‹·è´åŸå§‹æ•°æ®å¹¶è¿›è¡Œæ’åº</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (updateIndexesRecursively) &#123; <span class="comment">// æ›´æ–°ç´¢å¼•</span></span><br><span class="line">      <span class="title function_">updateIndexesRecursively</span>(newData, <span class="string">&#x27;&#x27;</span>); <span class="comment">// ä½¿ç”¨ç©ºå­—ç¬¦ä¸²ä½œä¸ºçˆ¶ç´¢å¼•</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (onChange) &#123; <span class="comment">// é€šçŸ¥çˆ¶ç»„ä»¶æ•°æ®å˜åŒ–</span></span><br><span class="line">      <span class="title function_">onChange</span>(newData);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å»¶è¿Ÿæ›´æ–°å±•å¼€çŠ¶æ€ï¼Œç¡®ä¿åœ¨æ•°æ®å®Œå…¨æ›´æ–°åå†æ›´æ–°å±•å¼€çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (updateExpandedKeys) &#123;</span><br><span class="line">      <span class="title function_">updateExpandedKeys</span>(oldIndex.<span class="title function_">toString</span>(), newIndex.<span class="title function_">toString</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">\</span><br></pre></td></tr></table></figure><p><code>DraggableTable</code>ä¼ å…¥<code>props</code>ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">updateExpandedKeys = <span class="function">(<span class="params">oldIndex, newIndex</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> currentKeys = <span class="title function_">cloneDeep</span>(expandedKeys);</span><br><span class="line">  <span class="keyword">const</span> res = []; <span class="comment">//ç”¨äºå­˜å‚¨éœ€è¦äº¤æ¢çš„ä¸¤é¡¹</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pushéœ€è¦äº¤æ¢çš„å±•å¼€è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (expandedKeys.<span class="title function_">includes</span>(oldIndex)) res.<span class="title function_">push</span>(newIndex);</span><br><span class="line">  <span class="keyword">if</span> (expandedKeys.<span class="title function_">includes</span>(newIndex)) res.<span class="title function_">push</span>(oldIndex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éå†å¹¶æ›¿æ¢éœ€è¦äº¤æ¢çš„è¡Œ</span></span><br><span class="line">  currentKeys = currentKeys.<span class="title function_">map</span>(<span class="function"><span class="params">currentKey</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> temp = currentKey.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentKey !== newIndex &amp;&amp; currentKey !== oldIndex) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç†éœ€è¦æ›¿æ¢çš„è¡Œ</span></span><br><span class="line">      <span class="keyword">if</span> (temp[<span class="number">0</span>] === oldIndex) &#123;</span><br><span class="line">        temp[<span class="number">0</span>] = newIndex;</span><br><span class="line">        <span class="keyword">return</span> temp.<span class="title function_">join</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (temp[<span class="number">0</span>] === newIndex) &#123;</span><br><span class="line">        temp[<span class="number">0</span>] = oldIndex;</span><br><span class="line">        <span class="keyword">return</span> temp.<span class="title function_">join</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currentKey; <span class="comment">// å…¶ä»–è¡Œä¸åšä»»ä½•æ”¹å˜</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç›´æ¥è¿”å›éœ€è¦äº¤æ¢çš„è¡Œ</span></span><br><span class="line">      <span class="keyword">return</span> currentKey;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°å±•å¼€çŠ¶æ€</span></span><br><span class="line">  <span class="title function_">setExpandedKeys</span>([...res, ...currentKeys]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> é¡¹ç›®å®æˆ˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> antd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React hooksæºç å­¦ä¹  â€”â€” useState</title>
      <link href="/2024/03/08/article3/"/>
      <url>/2024/03/08/article3/</url>
      
        <content type="html"><![CDATA[<p>Hooks çš„ä½¿ç”¨å¿…é¡»è¦ç¬¦åˆè¿™æ¡è§„åˆ™ï¼šç¡®ä¿ Hook åœ¨<span style="color: orange">æ¯ä¸€æ¬¡æ¸²æŸ“ä¸­éƒ½æŒ‰ç…§åŒæ ·çš„é¡ºåºè¢«è°ƒç”¨ã€‚</span></p><h1 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h1><p><code>useState</code> æ˜¯ React Hooks æä¾›çš„ä¸€ä¸ª Hookï¼Œç”¨äºåœ¨å‡½æ•°ç»„ä»¶ä¸­æ·»åŠ çŠ¶æ€ã€‚<br>å®ƒè¿”å›ä¸€ä¸ªçŠ¶æ€å˜é‡å’Œä¸€ä¸ªç”¨äºæ›´æ–°è¿™ä¸ªçŠ¶æ€çš„å‡½æ•°ã€‚</p><h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Example</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> [year, setYear] = <span class="title function_">useState</span>(<span class="number">2024</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>You clicked &#123;count&#125; times<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Year is &#123;year&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">          setCount(count + 1)</span></span><br><span class="line"><span class="language-xml">          setYear(year + 1)</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        click me</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>demoæ•ˆæœï¼š<br><img src="/img/article3/demo-1.jpg" ></p><div class="note green icon-padding modern"><i class="note-icon far fa-hand-scissors"></i><p><b>useState çš„å†…éƒ¨å®ç°åŸç†</b><br>1.åˆå§‹åŒ– ï¼šå½“ç»„ä»¶é¦–æ¬¡æ¸²æŸ“æ—¶ï¼ŒuseState ä¼šæ¥æ”¶ä¸€ä¸ªåˆå§‹çŠ¶æ€å€¼ï¼ˆä¾‹å¦‚ 0ï¼‰ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å†…éƒ¨çŠ¶æ€ä¸­ã€‚<br>2.çŠ¶æ€æ›´æ–° ï¼šè°ƒç”¨ setCount æ–¹æ³•æ—¶ï¼ŒReact ä¼šå°†æ–°çš„çŠ¶æ€å€¼å­˜å‚¨èµ·æ¥ï¼Œå¹¶è®¡åˆ’è§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚<br>3.é‡æ–°æ¸²æŸ“ ï¼šåœ¨é‡æ–°æ¸²æŸ“æ—¶ï¼ŒuseState ä¼šè¿”å›å½“å‰çš„çŠ¶æ€å€¼ï¼Œè€Œä¸æ˜¯åˆå§‹çŠ¶æ€å€¼ã€‚</p></div><h2 id="useState-vs-Redux"><a href="#useState-vs-Redux" class="headerlink" title="useState vs Redux"></a>useState vs Redux</h2><table><thead><tr><th>ç‰¹æ€§</th><th><code>useState</code></th><th>Redux</th></tr></thead><tbody><tr><td><strong>åº”ç”¨åœºæ™¯</strong></td><td>ç®€å•çš„ã€å±€éƒ¨çš„çŠ¶æ€ç®¡ç†</td><td>å¤æ‚çš„ã€å…¨å±€çš„çŠ¶æ€ç®¡ç†</td></tr><tr><td><strong>å®ç°æœºåˆ¶</strong></td><td>React å†…ç½®çš„ Hookï¼Œä½¿ç”¨ç®€å•ç›´æ¥</td><td>éœ€è¦é¢å¤–çš„é…ç½®ï¼ŒåŒ…æ‹¬ <code>store</code>ã€<code>reducer</code>ã€<code>action</code> ç­‰</td></tr><tr><td><strong>çŠ¶æ€ç®¡ç†</strong></td><td>ç»„ä»¶å†…éƒ¨çš„çŠ¶æ€ç®¡ç†</td><td>å…¨å±€çŠ¶æ€ç®¡ç†ï¼Œå¤šä¸ªç»„ä»¶å…±äº«çŠ¶æ€</td></tr><tr><td><strong>çŠ¶æ€æ›´æ–°</strong></td><td>é€šè¿‡ <code>setState</code> å‡½æ•°æ›´æ–°çŠ¶æ€</td><td>é€šè¿‡ <code>dispatch</code> å‘é€ <code>action</code>ï¼Œç”± <code>reducer</code> å¤„ç†</td></tr><tr><td><strong>æ€§èƒ½å½±å“</strong></td><td>åªå½±å“å½“å‰ç»„ä»¶åŠå…¶å­ç»„ä»¶ï¼Œå±€éƒ¨æ›´æ–°</td><td>å½±å“æ‰€æœ‰è®¢é˜…äº†çŠ¶æ€å˜åŒ–çš„ç»„ä»¶ï¼Œå…¨å±€æ›´æ–°</td></tr><tr><td><strong>å­¦ä¹ æ›²çº¿</strong></td><td>è¾ƒä½ï¼Œå®¹æ˜“ä¸Šæ‰‹</td><td>è¾ƒé«˜ï¼Œéœ€è¦ç†è§£ <code>store</code>ã€<code>reducer</code>ã€<code>action</code> ç­‰æ¦‚å¿µ</td></tr><tr><td><strong>çŠ¶æ€åˆå§‹åŒ–</strong></td><td><code>useState(initialValue)</code></td><td><code>const initialState = &#123;&#125;;</code> åœ¨ <code>reducer</code> ä¸­å®šä¹‰</td></tr><tr><td><strong>çŠ¶æ€æ›´æ–°æ–¹å¼</strong></td><td><code>setState(newState)</code></td><td><code>dispatch(&#123; type: &#39;ACTION_TYPE&#39;, payload: data &#125;)</code></td></tr><tr><td><strong>çŠ¶æ€è®¢é˜…</strong></td><td>è‡ªåŠ¨è®¢é˜…ï¼ŒçŠ¶æ€æ›´æ–°æ—¶ç»„ä»¶é‡æ–°æ¸²æŸ“</td><td>éœ€è¦ä½¿ç”¨ <code>connect</code> æˆ– <code>useSelector</code> è®¢é˜…çŠ¶æ€å˜åŒ–</td></tr></tbody></table><p>useStateçš„å®ç°ä¸Reduxç±»ä¼¼ï¼Œç»™å®šåˆå§‹ stateï¼Œé€šè¿‡ <code>dispatch</code> å‘é€ <code>action</code>ï¼Œç”± <code>reducer</code> å¤„ç† stateï¼Œè¿”å›æ–°çš„ stateï¼Œå¹¶è§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚</p><h1 id="æ‰‹å†™useState"><a href="#æ‰‹å†™useState" class="headerlink" title="æ‰‹å†™useState"></a>æ‰‹å†™useState</h1><p>ç»¼ä¸Šï¼Œæ ¹æ®useStateçš„å®ç°åŸç†ï¼Œå¯ä»¥å°è¯•æ‰‹å†™ä¸€ä¸ªuseStateï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><h2 id="a-å¤–éƒ¨å­˜å‚¨çŠ¶æ€å’Œç´¢å¼•"><a href="#a-å¤–éƒ¨å­˜å‚¨çŠ¶æ€å’Œç´¢å¼•" class="headerlink" title="a. å¤–éƒ¨å­˜å‚¨çŠ¶æ€å’Œç´¢å¼•"></a>a. å¤–éƒ¨å­˜å‚¨çŠ¶æ€å’Œç´¢å¼•</h2><p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªå¤–éƒ¨æ•°ç»„ <code>memoizedStates</code> ç”¨äºå­˜å‚¨æ‰€æœ‰çŠ¶æ€ï¼Œä»¥åŠä¸€ä¸ªå¤–éƒ¨å˜é‡ <code>index</code> ç”¨äºè®°å½•å½“å‰çŠ¶æ€çš„ç´¢å¼•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> memoizedStates = []</span><br><span class="line"><span class="keyword">let</span> index = <span class="number">0</span> <span class="comment">// è®°å½•å½“å‰stateçš„ç´¢å¼•</span></span><br></pre></td></tr></table></figure><h2 id="b-å®ç°-useState-å‡½æ•°"><a href="#b-å®ç°-useState-å‡½æ•°" class="headerlink" title="b. å®ç° useState å‡½æ•°"></a>b. å®ç° useState å‡½æ•°</h2><ul><li>åˆå§‹åŒ–çŠ¶æ€ï¼š åœ¨ <code>memoizedStates</code> ä¸­æŸ¥æ‰¾å½“å‰ç´¢å¼•çš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆå§‹åŒ–ä¸º <code>initialValue</code></li><li>å®šä¹‰ <code>setState</code> å‡½æ•°ï¼š ç”¨äºæ›´æ–° <code>memoizedStates</code> ä¸­çš„å€¼ï¼Œå¹¶è§¦å‘é‡æ–°æ¸²æŸ“ã€‚</li><li>è¿”å›çŠ¶æ€å’Œ <code>setState</code> å‡½æ•°ï¼š è¿”å›å½“å‰çŠ¶æ€å’Œ <code>setState</code> å‡½æ•°ï¼Œå¹¶å°† <code>index</code> åŠ 1ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è°ƒç”¨ useState æ—¶è®¿é—®ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚</li></ul><div class="note warning flat"><p><code>memoizedState</code> ä¾èµ–äº Hook çš„é¡ºåºè°ƒå­˜å–æ•°æ®ï¼Œå¦‚æœåœ¨å¾ªç¯ã€æ¡ä»¶ã€åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨ Hooks å¯¼è‡´ Hooks é¡ºåºå‘ç”Ÿå˜åŒ–ï¼Œ <code>memoizedState</code> å¹¶ä¸ä¼šæ„ŸçŸ¥åˆ°ï¼</p></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> memoizedStates = []</span><br><span class="line"><span class="keyword">let</span> index = <span class="number">0</span> <span class="comment">//è®°å½•å½“å‰stateçš„ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useState</span> = (<span class="params">initialValue</span>) =&gt; &#123;</span><br><span class="line">  memoizedStates[index] = memoizedStates[index] || initialValue</span><br><span class="line">  <span class="keyword">const</span> currentIndex = index</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setState</span> = (<span class="params">newState</span>) =&gt; &#123;</span><br><span class="line">    memoizedStates[currentIndex] = newState</span><br><span class="line">    index = <span class="number">0</span> <span class="comment">// é‡æ–°æ¸²æŸ“è¦æ¸…ç†</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [memoizedStates[index++], setState] <span class="comment">// è¿”å›å½“å‰stateï¼Œç´¢å¼•+1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿‡ç¨‹å›¾è§£"><a href="#è¿‡ç¨‹å›¾è§£" class="headerlink" title="è¿‡ç¨‹å›¾è§£"></a>è¿‡ç¨‹å›¾è§£</h2><h3 id="åˆæ¬¡æ¸²æŸ“"><a href="#åˆæ¬¡æ¸²æŸ“" class="headerlink" title="åˆæ¬¡æ¸²æŸ“"></a>åˆæ¬¡æ¸²æŸ“</h3><p>æ¯æ¬¡useStateæ‰§è¡Œæ—¶ï¼Œéƒ½å°†å¯¹åº”çš„setStateç»‘å®šåˆ°å¯¹åº”ç´¢å¼•çš„ä½ç½®ï¼Œç„¶åæŠŠåˆå§‹å€¼å­˜å…¥ <code>memoizedStates</code> ä¸­ã€‚</p><table style="undefined;table-layout: fixed; width: 400px">  <tr>    <th colspan="3">      <div>  const [count, setCount] = useState(0)</div>         <div>const [year, setYear] = useState(2024)</div>      </th>  </tr>  <tr>    <th>index</th>    <th>setState</th>    <th>state</th>  </tr>  <tr>    <td>0</td>    <td>setCount</td>    <td>0</td>  </tr>  <tr>    <td>1</td>    <td>setYear</td>    <td>2024</td>  </tr></table><h3 id="ç‚¹å‡»æŒ‰é’®"><a href="#ç‚¹å‡»æŒ‰é’®" class="headerlink" title="ç‚¹å‡»æŒ‰é’®"></a>ç‚¹å‡»æŒ‰é’®</h3><p>æŒ‰è°ƒç”¨é¡ºåºè§¦å‘ <code>setCount</code> å’Œ <code>setYear</code>ï¼Œæ¯ä¸ªsetStateå†…éƒ¨éƒ½ä½¿ç”¨ <code>currentIndex</code> ä¿å­˜äº†å¯¹åº”ç´¢å¼•ï¼Œè§¦å‘å¯¹åº”setStateä¼šæ”¹å˜å¯¹åº”çš„ <code>memoizedStates</code></p><table style="undefined;table-layout: fixed; width: 400px">  <tr>    <th colspan="3">      setCount(1)    </th>  </tr>  <tr>    <th colspan="3">      state[0] = 1     </th>  </tr>  <tr>    <th>index</th>    <th>setState</th>    <th>state</th>  </tr>  <tr>    <td>0</td>    <td>setCount</td>    <td>1</td>  </tr>  <tr>    <td>1</td>    <td>setYear</td>    <td>2024</td>  </tr>  <tr>    <th colspan="3">      stateæ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“    </th>  </tr>  <tr>    <th colspan="3">      setYear(2021)    </th>  </tr>  <tr>    <th>index</th>    <th>setState</th>    <th>state</th>  </tr>  <tr>    <td>0</td>    <td>setCount</td>    <td>1</td>  </tr>  <tr>    <td>1</td>    <td>setYear</td>    <td>2025</td>  </tr></table><p>æ¯æ¬¡setStateéƒ½ä¼šå¯¼è‡´é‡æ–°æ¸²æŸ“ï¼Œä¾æ—§æ˜¯ä¾æ¬¡æ‰§è¡ŒuseStateï¼Œä½† memoizedState ä¸­å·²ç»æœ‰äº†ä¸Šä¸€æ¬¡çš„ state å€¼ï¼Œå› æ­¤åˆå§‹åŒ–çš„å€¼å¹¶ä¸æ˜¯ä¼ å…¥çš„åˆå§‹å€¼è€Œæ˜¯ä¸Šä¸€æ¬¡çš„å€¼ã€‚</p><h1 id="æºç å­¦ä¹ ç¬”è®°"><a href="#æºç å­¦ä¹ ç¬”è®°" class="headerlink" title="æºç å­¦ä¹ ç¬”è®°"></a>æºç å­¦ä¹ ç¬”è®°</h1><h2 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h2><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react/src/ReactHooks.js">âœˆï¸ github-ReactHooks.js</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ReactSharedInternals</span> <span class="keyword">from</span> <span class="string">&#x27;shared/ReactSharedInternals&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveDispatcher</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = <span class="title class_">ReactSharedInternals</span>.<span class="property">H</span>;</span><br><span class="line">  <span class="keyword">return</span> dispatcher;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> useState&lt;S&gt;(<span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S) &#123;</span><br><span class="line">  <span class="keyword">const</span> dispatcher = <span class="title function_">resolveDispatcher</span>();</span><br><span class="line">  <span class="keyword">return</span> dispatcher.<span class="title function_">useState</span>(initialState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>resolveDispatcher()</code> å‡½æ•°ç”¨äºè·å–å½“å‰çš„dispatcherå®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹é€šå¸¸æ˜¯é€šè¿‡è®¿é—® <code>ReactSharedInternals</code> å†…éƒ¨çš„æŸä¸ªå±æ€§ï¼ˆå¦‚ <code>ReactCurrentDispatcher</code>ï¼‰æ¥è·å–çš„ã€‚<br><code>useState</code> å®é™…ä¸Šè°ƒç”¨çš„æ˜¯è¿™ä¸ª <code>dispatcher</code> å®ä¾‹ä¸Šçš„ <code>useState</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”±Reactå†…éƒ¨å®ç°ï¼Œç”¨äºç®¡ç†ç»„ä»¶çš„çŠ¶æ€</p><h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js">âœˆï¸ github-ReactFiberHooks.js</a></p><!-- ## ç±»å‹å®šä¹‰ã€ReactFiberHooks.jsã€‘ ä¸­æœ‰å¤šä¸ªå®šä¹‰çš„type (æ¶µç›–äº†åŸºæœ¬å®ç°ï¼‰ --><h3 id="ç±»å‹å®šä¹‰"><a href="#ç±»å‹å®šä¹‰" class="headerlink" title="ç±»å‹å®šä¹‰"></a>ç±»å‹å®šä¹‰</h3><h4 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h4><p>åœ¨Reactçš„ReactFiberHooks.jsæ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªHookç±»å‹ï¼Œæ˜¯ä¸€ä¸ª<b>å•å‘é“¾è¡¨</b>ï¼Œå®ƒä»£è¡¨äº†å‡½æ•°ç»„ä»¶ä¸­æ¯ä¸ªHookçš„å†…éƒ¨è¡¨ç¤ºï¼Œ<code>Hook.next</code>æŒ‡å‘ä¸‹ä¸€ä¸ªHookã€‚<br><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L197">âœˆï¸ github-ReactFiberHooks.js - Hook</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type <span class="title class_">Hook</span> = &#123;</span><br><span class="line">  <span class="attr">memoizedState</span>: any, </span><br><span class="line"></span><br><span class="line">  <span class="attr">baseState</span>: any, <span class="comment">// åˆå§‹åŒ– initialStateï¼Œ å·²ç»æ¯æ¬¡ dispatch ä¹‹å newState</span></span><br><span class="line">  <span class="attr">baseUpdate</span>: <span class="title class_">Update</span>&lt;any, any&gt; | <span class="literal">null</span>, <span class="comment">// å½“å‰éœ€è¦æ›´æ–°çš„ Update ï¼Œæ¯æ¬¡æ›´æ–°å®Œä¹‹åï¼Œä¼šèµ‹å€¼ä¸Šä¸€ä¸ª updateï¼Œæ–¹ä¾¿ react åœ¨æ¸²æŸ“é”™è¯¯çš„è¾¹ç¼˜ï¼Œæ•°æ®å›æº¯</span></span><br><span class="line">  <span class="attr">queue</span>: <span class="title class_">UpdateQueue</span>&lt;any, any&gt; | <span class="literal">null</span>, <span class="comment">// UpdateQueue é€šè¿‡ï¼Œæ›´æ–°é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">next</span>: <span class="title class_">Hook</span> | <span class="literal">null</span>,  <span class="comment">// link åˆ°ä¸‹ä¸€ä¸ª hooksï¼Œé€šè¿‡ next ä¸²è”æ¯ä¸ªhooks</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>memoizedStateï¼šå½“å‰Hookçš„çŠ¶æ€å€¼ï¼Œç”¨äºæ¸²æŸ“ç»„ä»¶ã€‚</li><li>baseStateï¼šHookçš„åˆå§‹çŠ¶æ€æˆ–ä¸Šä¸€æ¬¡æ›´æ–°åçš„çŠ¶æ€ï¼Œç”¨äºæ¯”è¾ƒå’Œè§¦å‘é‡æ–°æ¸²æŸ“ã€‚</li><li>baseQueue&#x2F;queueï¼šæŒ‡å‘æ›´æ–°é˜Ÿåˆ—çš„æŒ‡é’ˆï¼Œå­˜å‚¨å¾…å¤„ç†çš„æ›´æ–°ã€‚baseQueueåœ¨æ›´æ–°å¤„ç†æœŸé—´ä¿æŒä¸å˜ï¼Œè€Œqueueåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶é‡ç½®ã€‚</li><li>nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªHookå¯¹è±¡çš„æŒ‡é’ˆï¼Œå½¢æˆHooké“¾ã€‚</li></ul><h4 id="Update-UpdateQueue"><a href="#Update-UpdateQueue" class="headerlink" title="Update + UpdateQueue"></a>Update + UpdateQueue</h4><p>åœ¨Reactä¸­ï¼Œç»„ä»¶çš„çŠ¶æ€å˜åŒ–é€šè¿‡æ›´æ–°å¯¹è±¡å’Œæ›´æ–°é˜Ÿåˆ—æ¥ç®¡ç†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type <span class="title class_">Update</span>&lt;S, A&gt; = &#123;</span><br><span class="line">  <span class="attr">lane</span>: <span class="title class_">Lane</span>,</span><br><span class="line">  <span class="attr">revertLane</span>: <span class="title class_">Lane</span>,</span><br><span class="line">  <span class="attr">action</span>: A,</span><br><span class="line">  <span class="attr">hasEagerState</span>: boolean,</span><br><span class="line">  <span class="attr">eagerState</span>: S | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">next</span>: <span class="title class_">Update</span>&lt;S, A&gt;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">UpdateQueue</span>&lt;S, A&gt; = &#123;</span><br><span class="line">  <span class="attr">pending</span>: <span class="title class_">Update</span>&lt;S, A&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lanes</span>: <span class="title class_">Lanes</span>,</span><br><span class="line">  <span class="attr">dispatch</span>: (<span class="function"><span class="params">A</span> =&gt;</span> mixed) | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lastRenderedReducer</span>: (<span class="function">(<span class="params">S, A</span>) =&gt;</span> S) | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lastRenderedState</span>: S | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>æ›´æ–°ï¼ˆUpdateï¼‰ï¼šå½“ç»„ä»¶çŠ¶æ€éœ€è¦æ”¹å˜æ—¶ï¼ˆå¦‚è°ƒç”¨setStateï¼‰ï¼ŒReactä¼šåˆ›å»ºä¸€ä¸ªæ›´æ–°å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡åŒ…å«æ–°çŠ¶æ€å€¼ï¼ˆæˆ–è®¡ç®—æ–°çŠ¶æ€çš„åŠ¨ä½œï¼‰åŠæ›´æ–°æ‰€å±çš„é€šé“ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰ã€‚</li><li>æ›´æ–°é˜Ÿåˆ—ï¼ˆUpdateQueueï¼‰ï¼šæ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰å¾…å¤„ç†çš„æ›´æ–°å¯¹è±¡ã€‚ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼ŒReactä¼šéå†é˜Ÿåˆ—ï¼Œåº”ç”¨æ›´æ–°å¹¶è®¡ç®—æ–°çŠ¶æ€ã€‚</li></ul><h4 id="HooksæŒ‚è½½å’Œæ›´æ–°"><a href="#HooksæŒ‚è½½å’Œæ›´æ–°" class="headerlink" title="HooksæŒ‚è½½å’Œæ›´æ–°"></a>HooksæŒ‚è½½å’Œæ›´æ–°</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L4136">âœˆï¸ github-ReactFiberHooks.js - HooksDispatcherOnMountå®Œæ•´ä»£ç </a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HooksDispatcherOnMount</span>: <span class="title class_">Dispatcher</span> = &#123;</span><br><span class="line">  readContext,</span><br><span class="line"></span><br><span class="line">  use,</span><br><span class="line">  <span class="attr">useContext</span>: readContext,</span><br><span class="line">  <span class="attr">useEffect</span>: mountEffect, <span class="comment">// æŒ‚è½½é˜¶æ®µå¤„ç†å‰¯ä½œç”¨</span></span><br><span class="line">  <span class="attr">useState</span>: mountState, <span class="comment">// æ·»åŠ ä¸€ä¸ªçŠ¶æ€ï¼ˆæŒ‚è½½é˜¶æ®µï¼‰</span></span><br><span class="line">  ....</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HooksDispatcherOnUpdate</span>: <span class="title class_">Dispatcher</span> = &#123;</span><br><span class="line">  readContext,</span><br><span class="line"></span><br><span class="line">  use,</span><br><span class="line">  <span class="attr">useContext</span>: readContext,</span><br><span class="line">  <span class="attr">useEffect</span>: updateEffect, <span class="comment">// æ›´æ–°é˜¶æ®µå¤„ç†å‰¯ä½œç”¨</span></span><br><span class="line">  <span class="attr">useState</span>: updateState, <span class="comment">// æ·»åŠ ä¸€ä¸ªçŠ¶æ€ï¼ˆæ›´æ–°é˜¶æ®µï¼‰  </span></span><br><span class="line">  ....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p>HooksDispatcherOnMountï¼šç»„ä»¶é¦–æ¬¡æ¸²æŸ“ï¼ˆæŒ‚è½½ï¼‰æ—¶ï¼ŒReactä½¿ç”¨çš„Hooksè°ƒåº¦å™¨ï¼Œç”¨äºåˆå§‹åŒ–Hooksã€‚</p></li><li><p>HooksDispatcherOnUpdateï¼šç»„ä»¶åç»­æ›´æ–°æ—¶ï¼ŒReactä½¿ç”¨çš„Hooksè°ƒåº¦å™¨ï¼Œç”¨äºæ›´æ–°Hooksçš„çŠ¶æ€æˆ–å‰¯ä½œç”¨ã€‚</p></li></ul><p>è¿™ä¸¤ä¸ªè°ƒåº¦å™¨ç¡®ä¿äº†Hooksåœ¨ç»„ä»¶çš„ä¸åŒç”Ÿå‘½å‘¨æœŸé˜¶æ®µèƒ½å¤Ÿæ­£ç¡®åœ°å·¥ä½œã€‚</p><h3 id="é¦–æ¬¡æ¸²æŸ“"><a href="#é¦–æ¬¡æ¸²æŸ“" class="headerlink" title="é¦–æ¬¡æ¸²æŸ“"></a>é¦–æ¬¡æ¸²æŸ“</h3><h4 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberBeginWork.js#L3769">âœˆï¸ github-ReactFiberBeginWork.js - beginWork</a><br>åˆæ¬¡æ¸²æŸ“ï¼ŒReact Fiberä»<code>beginWork()</code>å¼€å§‹æ‰§è¡Œï¼Œå®ƒè´Ÿè´£å¤„ç† React å…ƒç´ æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ã€‚<br>å®ƒæ ¹æ®èŠ‚ç‚¹çš„ç±»å‹ï¼ˆå¦‚å‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ã€åŸç”Ÿ DOM å…ƒç´ ç­‰ï¼‰è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™äº›å¤„ç†å‡½æ•°è´Ÿè´£æ›´æ–° Fiber èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¹¶ç¡®å®šå“ªäº›èŠ‚ç‚¹éœ€è¦è¢«é‡æ–°æ¸²æŸ“ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Fiber</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šè¿‡æ£€æŸ¥currentï¼ˆå½“å‰FiberèŠ‚ç‚¹ï¼‰æ˜¯å¦ä¸ºnullæ¥åˆ¤æ–­æ˜¯å¦é¦–æ¬¡æ¸²æŸ“</span></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ç•¥</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°æ ‡è®°ï¼šå¦‚æœæ›´æ–°é˜Ÿåˆ—æˆ–è€…contextå‘ç”Ÿäº†æ”¹å˜ï¼Œç½®ä¸ºtrue</span></span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨è¿›å…¥beginé˜¶æ®µä¹‹å‰ï¼Œå…ˆæ¸…é™¤æ›´æ–°ä¼˜å…ˆçº§</span></span><br><span class="line">  workInProgress.<span class="property">lanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®èŠ‚ç‚¹çš„ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="comment">// å‡½æ•°ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Component</span> = workInProgress.<span class="property">type</span>;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.<span class="property">pendingProps</span>;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        disableDefaultPropsExceptForClasses ||</span><br><span class="line">        workInProgress.<span class="property">elementType</span> === <span class="title class_">Component</span></span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : <span class="title function_">resolveDefaultPropsOnNonClassComponent</span>(<span class="title class_">Component</span>, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">updateFunctionComponent</span>(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="title class_">Component</span>,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">      <span class="comment">// ç•¥</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œhookså®é™…è°ƒç”¨<code>updateFunctionComponent</code>ï¼Œå®ƒè´Ÿè´£å¤„ç†å‡½æ•°ç»„ä»¶çš„æ›´æ–°é€»è¾‘ã€‚</p><h4 id="updateFunctionComponent"><a href="#updateFunctionComponent" class="headerlink" title="updateFunctionComponent"></a>updateFunctionComponent</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberBeginWork.js#L10728">âœˆï¸ github-ReactFiberBeginWork.js - updateFunctionComponent</a>æ›´æ–°é€»è¾‘å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateFunctionComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: <span class="literal">null</span> | Fiber, <span class="comment">// å½“å‰FiberèŠ‚ç‚¹</span></span></span><br><span class="line"><span class="params">  workInProgress: Fiber, <span class="comment">// å½“å‰æ­£åœ¨å¤„ç†çš„FiberèŠ‚ç‚¹</span></span></span><br><span class="line"><span class="params">  Component: any, <span class="comment">// ç»„ä»¶å‡½æ•°</span></span></span><br><span class="line"><span class="params">  nextProps: any, <span class="comment">// æ–°çš„props</span></span></span><br><span class="line"><span class="params">  renderLanes: Lanes, <span class="comment">// æ¸²æŸ“ä¼˜å…ˆçº§</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> nextChildren</span><br><span class="line">  <span class="comment">// è¯»å–ä¸Šä¸‹æ–‡</span></span><br><span class="line">  <span class="title function_">prepareToReadContext</span>(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">  nextChildren = <span class="title function_">renderWithHooks</span>(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    nextProps,</span><br><span class="line">    context,</span><br><span class="line">    renderLanes,</span><br><span class="line">  );</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; !didReceiveUpdate) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ bailoutHooks å’Œ bailoutOnAlreadyFinishedWork æ¥è·³è¿‡æœªæ›´æ–°çš„ç»„ä»¶</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="title function_">reconcileChildren</span>(current, workInProgress, nextChildren, renderLanes);</span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸²æŸ“å…¥å£ä¸ºrenderWithHooksã€‚</p><h4 id="renderWithHooks"><a href="#renderWithHooks" class="headerlink" title="renderWithHooks"></a>renderWithHooks</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L546">âœˆï¸ github-ReactFiberHooks.js - renderWithHooks</a><br><code>renderWithHooks</code> æ˜¯Reactå†…éƒ¨ç”¨äºå¤„ç†ç»„ä»¶æ¸²æŸ“çš„å‡½æ•°ï¼Œå¹¶åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯èƒ½è§¦å‘åŒé‡æ¸²æŸ“ä»¥æ£€æµ‹å‰¯ä½œç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> renderWithHooks&lt;<span class="title class_">Props</span>, <span class="title class_">SecondArg</span>&gt;(</span><br><span class="line">  <span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="title class_">Component</span>: <span class="function">(<span class="params">p: Props, arg: SecondArg</span>) =&gt;</span> any,</span><br><span class="line">  <span class="attr">props</span>: <span class="title class_">Props</span>,</span><br><span class="line">  <span class="attr">secondArg</span>: <span class="title class_">SecondArg</span>,</span><br><span class="line">  <span class="attr">nextRenderLanes</span>: <span class="title class_">Lanes</span>,</span><br><span class="line">): any &#123;</span><br><span class="line">  <span class="comment">// ç•¥</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ç•¥</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®Hooksåˆ†å‘å™¨</span></span><br><span class="line">    <span class="title class_">ReactSharedInternals</span>.<span class="property">H</span> = current === <span class="literal">null</span> || current.<span class="property">memoizedState</span> === <span class="literal">null</span></span><br><span class="line">      ? <span class="title class_">HooksDispatcherOnMount</span></span><br><span class="line">      : <span class="title class_">HooksDispatcherOnUpdate</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒé‡æ¸²æŸ“ï¼ˆStrict Modeï¼‰ï¼š</span></span><br><span class="line">  <span class="comment">// åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœå¯ç”¨äº†ä¸¥æ ¼æ¨¡å¼ï¼ˆStrictModeï¼‰ï¼Œåˆ™ç»„ä»¶å¯èƒ½ä¼šè¢«æ¸²æŸ“ä¸¤æ¬¡ã€‚è¿™æ˜¯ä¸ºäº†æ›´å®¹æ˜“åœ°æ£€æµ‹åˆ°å‰¯ä½œç”¨ã€‚</span></span><br><span class="line">  <span class="comment">// åŒé‡æ¸²æŸ“æœŸé—´ï¼Œé¦–æ¬¡æ¸²æŸ“ä¼šè°ƒç”¨ç»„ä»¶å‡½æ•°ä¸¤æ¬¡ï¼ˆä½† Hooks çš„çŠ¶æ€åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ä¼šå¤ç”¨ï¼‰ï¼Œè€Œç¬¬äºŒæ¬¡ï¼ˆå®é™…çš„ï¼‰æ¸²æŸ“åˆ™ä¸ä¼šã€‚</span></span><br><span class="line">  <span class="comment">// è¿™ç¡®ä¿äº†åƒ useMemo è¿™æ ·çš„ Hook åœ¨ä¾èµ–é¡¹ç›¸åŒæ—¶ä¸ä¼šé‡å¤è¿è¡Œã€‚</span></span><br><span class="line">  <span class="keyword">const</span> shouldDoubleRenderDEV =</span><br><span class="line">    __DEV__ &amp;&amp; (workInProgress.<span class="property">mode</span> &amp; <span class="title class_">StrictLegacyMode</span>) !== <span class="title class_">NoMode</span>;</span><br><span class="line"></span><br><span class="line">  shouldDoubleInvokeUserFnsInHooksDEV = shouldDoubleRenderDEV;</span><br><span class="line">  <span class="keyword">let</span> children = __DEV__</span><br><span class="line">    ? <span class="title function_">callComponentInDEV</span>(<span class="title class_">Component</span>, props, secondArg)</span><br><span class="line">    : <span class="title class_">Component</span>(props, secondArg);</span><br><span class="line">  shouldDoubleInvokeUserFnsInHooksDEV = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨äºæŒ‡ç¤ºåœ¨å½“å‰æ¸²æŸ“é˜¶æ®µæ˜¯å¦æœ‰è®¡åˆ’è¿›è¡Œé¢å¤–çš„æ¸²æŸ“æ›´æ–°ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (didScheduleRenderPhaseUpdateDuringThisPass) &#123;</span><br><span class="line">    children = <span class="title function_">renderWithHooksAgain</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      props,</span><br><span class="line">      secondArg,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦éœ€è¦åŒé‡æ¸²æŸ“</span></span><br><span class="line">  <span class="keyword">if</span> (shouldDoubleRenderDEV) &#123;</span><br><span class="line">    <span class="title function_">setIsStrictModeForDevtools</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      children = <span class="title function_">renderWithHooksAgain</span>(</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="title class_">Component</span>,</span><br><span class="line">        props,</span><br><span class="line">        secondArg,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="title function_">setIsStrictModeForDevtools</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">finishRenderingHooks</span>(current, workInProgress, <span class="title class_">Component</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ol><li>è®¾ç½®Hooksåˆ†å‘å™¨ï¼šæ ¹æ®å½“å‰çš„å¼€å‘æ¨¡å¼å’ŒFiberï¼ˆå·¥ä½œå•å…ƒï¼‰çš„çŠ¶æ€ï¼Œé€‰æ‹©åˆé€‚çš„Hooksåˆ†å‘å™¨ã€‚</li><li>åˆ¤æ–­åŒé‡æ¸²æŸ“éœ€æ±‚ï¼šå¦‚æœå¤„äºå¼€å‘æ¨¡å¼ä¸”å¯ç”¨äº†ä¸¥æ ¼æ¨¡å¼ï¼Œåˆ™è®¾ç½®æ ‡å¿—ä»¥æŒ‡ç¤ºéœ€è¦è¿›è¡ŒåŒé‡æ¸²æŸ“ã€‚</li><li>é¦–æ¬¡æ¸²æŸ“å¹¶å¯èƒ½åŒé‡è°ƒç”¨ï¼šè°ƒç”¨ç»„ä»¶å‡½æ•°è¿›è¡Œé¦–æ¬¡æ¸²æŸ“ã€‚åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœå¯ç”¨äº†åŒé‡æ¸²æŸ“ï¼Œåˆ™ç»„ä»¶å‡½æ•°å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼ˆä½†Hooksçš„çŠ¶æ€åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ä¼šå¤ç”¨ï¼‰ã€‚</li><li>å¤„ç†æ¸²æŸ“é˜¶æ®µæ›´æ–°ï¼šå¦‚æœåœ¨é¦–æ¬¡æ¸²æŸ“é˜¶æ®µæœ‰æ›´æ–°å‘ç”Ÿï¼Œåˆ™é‡å¤æ¸²æŸ“è¿‡ç¨‹ï¼Œç›´åˆ°ç»„ä»¶çŠ¶æ€ç¨³å®šï¼Œä¸å†äº§ç”Ÿæ–°çš„æ¸²æŸ“é˜¶æ®µæ›´æ–°ã€‚</li></ol><h5 id="æ ¸å¿ƒæœºåˆ¶"><a href="#æ ¸å¿ƒæœºåˆ¶" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶"></a>æ ¸å¿ƒæœºåˆ¶</h5><p>renderWithHooks å‡½æ•°çš„æ ¸å¿ƒåœ¨äºæ ¹æ®å½“å‰Fiberçš„çŠ¶æ€æ¥è®¾ç½®ReactCurrentDispatcherï¼Œè¿™æ˜¯Reactç”¨æ¥åˆ†å‘Hooksè°ƒç”¨çš„æœºåˆ¶ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactSharedInternals</span>.<span class="property">H</span> =</span><br><span class="line">  current === <span class="literal">null</span> || current.<span class="property">memoizedState</span> === <span class="literal">null</span></span><br><span class="line">    ? <span class="title class_">HooksDispatcherOnMount</span></span><br><span class="line">    : <span class="title class_">HooksDispatcherOnUpdate</span>;</span><br></pre></td></tr></table></figure><ul><li>é¦–æ¬¡æŒ‚è½½<br>å½“currentï¼ˆå³å½“å‰çš„FiberèŠ‚ç‚¹ï¼‰ä¸ºç©ºï¼Œæˆ–è€…current.memoizedStateä¸ºç©ºæ—¶ï¼Œä¸ºé¦–æ¬¡åŠ è½½;<br><code>useState</code>ä¸º<code>HooksDispatcherOnMount.useState</code>, ï¼ˆå³<code>mountState</code>ï¼‰</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useState = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>.<span class="property">useState</span> </span><br><span class="line">         = <span class="title class_">HooksDispatcherOnMount</span>.<span class="property">useState</span> </span><br><span class="line">         = mountState</span><br></pre></td></tr></table></figure><ul><li>æ›´æ–°é˜¶æ®µ<br>å½“ç»„ä»¶å¤„äºæ›´æ–°é˜¶æ®µæ—¶ï¼Œcurrentä¸ä¸ºç©ºä¸”current.memoizedStateä¹Ÿä¸ä¸ºç©ºã€‚<br><code>useState</code>ä¸º<code>HooksDispatcherOnUpdate.useState</code>, ï¼ˆå³<code>updateState</code>ï¼‰</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useState = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>.<span class="property">useState</span> </span><br><span class="line">         = <span class="title class_">HooksDispatcherOnUpdate</span>.<span class="property">useState</span> </span><br><span class="line">         = updateState</span><br></pre></td></tr></table></figure><h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h3><h4 id="mountState"><a href="#mountState" class="headerlink" title="mountState"></a>mountState</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L1907">âœˆï¸ github-ReactFiberHooks.js - mountStateImpl and mountState</a><br>mountState å‡½æ•°çš„ä½œç”¨æ˜¯æ¨¡æ‹Ÿ React çš„ useState é’©å­ï¼Œé€šè¿‡æ‰‹åŠ¨æ–¹å¼åˆå§‹åŒ–çŠ¶æ€å¹¶åˆ›å»ºä¸€ä¸ªç”¨äºæ›´æ–°è¯¥çŠ¶æ€çš„ dispatch å‡½æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºæ–¹ä¾¿ç†è§£ï¼Œå°†mountStateImplçš„å‡½æ•°å†…å®¹ç›´æ¥åŠ åˆ°mountStateå‡½æ•°ä¸­äº†</span></span><br><span class="line"><span class="keyword">function</span> mountState&lt;S&gt;(</span><br><span class="line">  <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S,</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. ç»„ä»¶æŒ‚è½½æ—¶ç”Ÿäº§ä¸€ä¸ªhookå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 2. åˆå§‹stateç»‘å®šåˆ°hookå¯¹è±¡ä¸Š</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    initialState = <span class="title function_">initialState</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. åˆ›å»ºçŠ¶æ€é˜Ÿåˆ—ï¼Œè®°å½•hookå€¼çš„æ”¹å˜</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">UpdateQueue</span>&lt;S, <span class="title class_">BasicStateAction</span>&lt;S&gt;&gt; = &#123;</span><br><span class="line">    <span class="attr">pending</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">dispatch</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lastRenderedReducer</span>: basicStateReducer,</span><br><span class="line">    <span class="attr">lastRenderedState</span>: (<span class="attr">initialState</span>: any),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> queue = hook.<span class="property">queue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. åˆ›å»º dispatch å‡½æ•°ï¼Œæ›´æ”¹çŠ¶æ€çš„æ–¹æ³•</span></span><br><span class="line">  <span class="comment">// é€šè¿‡é—­åŒ…çš„æ–¹å¼ï¼Œå®ç°é˜Ÿåˆ—åœ¨ä¸åŒå‡½æ•°ä¸­çš„å…±äº«ã€‚å‰ææ˜¯æ¯æ¬¡ç”¨çš„ dispatch å‡½æ•°æ˜¯åŒä¸€ä¸ª</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt; = (dispatchSetState.<span class="title function_">bind</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    currentlyRenderingFiber,</span><br><span class="line">    queue,</span><br><span class="line">  ): any);</span><br><span class="line">  <span class="comment">// 4.1. ç»‘å®š dispatch åˆ°é˜Ÿåˆ—</span></span><br><span class="line">  queue.<span class="property">dispatch</span> = dispatch;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 5. è¿”å›çŠ¶æ€å’Œ dispatch å‡½æ•°</span></span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>mountWorkInProgressHook</code>ï¼šåˆ›å»ºhookå¯¹è±¡</li><li><code>dispatchSetState</code>ï¼šæ›´æ–°çŠ¶æ€</li></ul><h4 id="mountWorkInProgressHook"><a href="#mountWorkInProgressHook" class="headerlink" title="mountWorkInProgressHook"></a>mountWorkInProgressHook</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L1023">âœˆï¸ github-ReactFiberHooks.js - mountWorkInProgressHook</a><br>åœ¨ç»„ä»¶çš„æ¸²æŸ“è¿‡ç¨‹ä¸­åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ hook å¯¹è±¡ï¼Œå°†å…¶é“¾æ¥åˆ°å½“å‰ fiber èŠ‚ç‚¹çš„ hook é“¾è¡¨ä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountWorkInProgressHook</span>(<span class="params"></span>): <span class="title class_">Hook</span> &#123;</span><br><span class="line">  <span class="comment">//1. åˆå§‹åŒ–ä¸€ä¸ªhook</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">hook</span>: <span class="title class_">Hook</span> = &#123;</span><br><span class="line">    <span class="attr">memoizedState</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">baseState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">queue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">baseUpdate</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. å½“å‰æ­£åœ¨å¤„ç†çš„hook</span></span><br><span class="line">    <span class="comment">// å¤„ç†ç¬¬ä¸€ä¸ª Hook</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">    firstWorkInProgressHook = workInProgressHook = hook;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»æœ‰æ­£åœ¨å¤„ç†çš„ hookï¼Œå°†å½“å‰æ­£åœ¨å¤„ç†çš„ hook çš„next å±æ€§æŒ‡å‘æ–°åˆ›å»ºçš„ hook å¯¹è±¡</span></span><br><span class="line">    workInProgressHook = workInProgressHook.<span class="property">next</span> = hook;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="dispatchSetState"><a href="#dispatchSetState" class="headerlink" title="dispatchSetState"></a>dispatchSetState</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L3725">âœˆï¸ github-ReactFiberHooks.js - dispatchSetStateInternal and dispatchSetState</a><br>ç»‘å®šå½“å‰ fiber å’Œ queue åˆ° dispatchAction<br>å‡½æ•°æ ¹æ®å½“å‰æ˜¯åœ¨æ¸²æŸ“é˜¶æ®µè¿˜æ˜¯éæ¸²æŸ“é˜¶æ®µè§¦å‘æ›´æ–°ï¼Œä»¥åŠæ˜¯å¦æœ‰å¾…å¤„ç†çš„æ›´æ–°æˆ–æ˜¯å¦å¯ä»¥æå‰è®¡ç®—çŠ¶æ€ï¼Œæ¥å†³å®šå¦‚ä½•å¤„ç†çŠ¶æ€æ›´æ–°ã€‚åœ¨å¹¶å‘æ¨¡å¼ä¸‹ï¼Œå®ƒè¿˜éœ€è¦å¤„ç†ä¸è¿‡æ¸¡ç›¸å…³çš„é€»è¾‘ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> dispatchSetState&lt;S, A&gt;(</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="attr">queue</span>: <span class="title class_">UpdateQueue</span>&lt;S, A&gt;,</span><br><span class="line">  <span class="attr">action</span>: A,</span><br><span class="line">): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼didScheduleUpdateï¼Œè¡¨ç¤ºæ˜¯å¦æˆåŠŸå®‰æ’äº†æ›´æ–°</span></span><br><span class="line">  <span class="keyword">const</span> didScheduleUpdate = <span class="title function_">dispatchSetStateInternal</span>(</span><br><span class="line">    fiber,</span><br><span class="line">    queue,</span><br><span class="line">    action,</span><br><span class="line">    lane,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// å¦‚æœdidScheduleUpdateä¸ºtrueï¼Œåˆ™å¼€å§‹æ›´æ–°è®¡æ—¶</span></span><br><span class="line">  <span class="keyword">if</span> (didScheduleUpdate) &#123;</span><br><span class="line">    <span class="title function_">startUpdateTimerByLane</span>(lane);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åœ¨React DevToolsä¸­æ ‡è®°è¿™æ¬¡æ›´æ–°</span></span><br><span class="line">  <span class="title function_">markUpdateInDevTools</span>(fiber, lane, action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dispatchSetStateInternal å‡½æ•°ï¼Œæ˜¯React å†…éƒ¨çŠ¶æ€æ›´æ–°æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¤„ç† hooks çš„çŠ¶æ€æ›´æ–°è¯·æ±‚ã€‚<br>å‡½æ•°æ ¹æ®å½“å‰æ˜¯åœ¨æ¸²æŸ“é˜¶æ®µè¿˜æ˜¯éæ¸²æŸ“é˜¶æ®µè§¦å‘æ›´æ–°ï¼Œä»¥åŠæ˜¯å¦æœ‰å¾…å¤„ç†çš„æ›´æ–°æˆ–æ˜¯å¦å¯ä»¥æå‰è®¡ç®—çŠ¶æ€ï¼Œæ¥å†³å®šå¦‚ä½•å¤„ç†çŠ¶æ€æ›´æ–°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> dispatchSetStateInternal&lt;S, A&gt;(</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,       </span><br><span class="line">  <span class="attr">queue</span>: <span class="title class_">UpdateQueue</span>&lt;S, A&gt;, </span><br><span class="line">  <span class="attr">action</span>: A,          </span><br><span class="line">  <span class="attr">lane</span>: <span class="title class_">Lane</span>,         </span><br><span class="line">): boolean &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„æ›´æ–°å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">Update</span>&lt;S, A&gt; = &#123;</span><br><span class="line">    lane,              </span><br><span class="line">    <span class="attr">revertLane</span>: <span class="title class_">NoLane</span>, </span><br><span class="line">    action,           </span><br><span class="line">    <span class="attr">hasEagerState</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="attr">eagerState</span>: <span class="literal">null</span>,  </span><br><span class="line">    <span class="attr">next</span>: (<span class="attr">null</span>: any), </span><br><span class="line">  &#125;;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯åœ¨æ¸²æŸ“é˜¶æ®µè§¦å‘çš„æ›´æ–°</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isRenderPhaseUpdate</span>(fiber)) &#123;</span><br><span class="line">    <span class="comment">// åˆ™å°†æ›´æ–°æ·»åŠ åˆ°æ¸²æŸ“é˜¶æ®µçš„æ›´æ–°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="title function_">enqueueRenderPhaseUpdate</span>(queue, update);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦åˆ™ï¼Œå¤„ç†éæ¸²æŸ“é˜¶æ®µçš„æ›´æ–°</span></span><br><span class="line">    <span class="keyword">const</span> alternate = fiber.<span class="property">alternate</span>; <span class="comment">// è·å–å½“å‰ fiber çš„å¤‡ç”¨ fiberï¼ˆç”¨äºå¹¶å‘æ¨¡å¼ï¼‰</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰ fiber å’Œå¤‡ç”¨ fiber éƒ½æ²¡æœ‰å¾…å¤„ç†çš„æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      fiber.<span class="property">lanes</span> === <span class="title class_">NoLanes</span> &amp;&amp;</span><br><span class="line">      (alternate === <span class="literal">null</span> || alternate.<span class="property">lanes</span> === <span class="title class_">NoLanes</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œå¯ä»¥å°è¯•æå‰è®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€</span></span><br><span class="line">      <span class="keyword">const</span> lastRenderedReducer = queue.<span class="property">lastRenderedReducer</span>; <span class="comment">// è·å–ä¸Šæ¬¡æ¸²æŸ“æ—¶ä½¿ç”¨çš„ reducer</span></span><br><span class="line">      <span class="keyword">if</span> (lastRenderedReducer !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> prevDispatcher = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">currentState</span>: S = (queue.<span class="property">lastRenderedState</span>: any); <span class="comment">// è·å–å½“å‰çŠ¶æ€</span></span><br><span class="line">          <span class="comment">// ä½¿ç”¨ä¸Šæ¬¡çš„ reducer å’Œå½“å‰çš„åŠ¨ä½œè®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€</span></span><br><span class="line">          <span class="keyword">const</span> eagerState = <span class="title function_">lastRenderedReducer</span>(currentState, action);</span><br><span class="line">          <span class="comment">// æ›´æ–°å¯¹è±¡ä¸Šæ ‡è®°å·²æå‰è®¡ç®—çŠ¶æ€ï¼Œå¹¶å­˜å‚¨è®¡ç®—åçš„çŠ¶æ€</span></span><br><span class="line">          update.<span class="property">hasEagerState</span> = <span class="literal">true</span>;</span><br><span class="line">          update.<span class="property">eagerState</span> = eagerState;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// å¦‚æœæ–°çŠ¶æ€ä¸æ—§çŠ¶æ€ç›¸åŒï¼Œåˆ™å¯ä»¥å°è¯•ç›´æ¥é€€å‡ºæ›´æ–°æµç¨‹</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">is</span>(eagerState, currentState)) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ç‰¹æ®Šæ–¹æ³•å¤„ç†å¹¶å‘æ¨¡å¼ä¸‹çš„è¿™ç§æƒ…å†µï¼Œå¹¶è¿”å› false è¡¨ç¤ºæœªå®‰æ’é‡æ–°æ¸²æŸ“</span></span><br><span class="line">            <span class="title function_">enqueueConcurrentHookUpdateAndEagerlyBailout</span>(fiber, queue, update);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ»¡è¶³æå‰è®¡ç®—çŠ¶æ€çš„æ¡ä»¶ï¼Œåˆ™æ­£å¸¸å¤„ç†æ›´æ–°</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">enqueueConcurrentHookUpdate</span>(fiber, queue, update, lane);</span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">scheduleUpdateOnFiber</span>(root, fiber, lane);</span><br><span class="line">      <span class="title function_">entangleTransitionUpdate</span>(root, queue, lane);</span><br><span class="line">      <span class="comment">// è¿”å› true è¡¨ç¤ºå·²å®‰æ’é‡æ–°æ¸²æŸ“</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰å®‰æ’é‡æ–°æ¸²æŸ“ï¼Œåˆ™è¿”å› false</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h3><p><code>renderWithHooks</code>ä¸­çš„<code>ReactCurrentDispatcher</code>éƒ¨åˆ†ï¼Œæ›´æ–°è¿‡ç¨‹è°ƒç”¨<code>updateState</code></p><h4 id="updateState"><a href="#updateState" class="headerlink" title="updateState"></a>updateState</h4><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L1949">âœˆï¸ github-ReactFiberHooks.js - updateState</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> updateState&lt;S&gt;(</span><br><span class="line">  <span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S,</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">updateReducer</span>(basicStateReducer, (<span class="attr">initialState</span>: any));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…è°ƒç”¨çš„æ˜¯ <code>updateReducer</code>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> updateReducer&lt;S, I, A&gt;(</span><br><span class="line">  <span class="attr">reducer</span>: <span class="function">(<span class="params">S, A</span>) =&gt;</span> S,</span><br><span class="line">  <span class="attr">initialArg</span>: I,</span><br><span class="line">  init?: <span class="function"><span class="params">I</span> =&gt;</span> S,</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;A&gt;] &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>(); <span class="comment">// è·å–å½“å‰å·¥ä½œçš„Hook, å³ workInProgressHook</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">updateReducerImpl</span>(hook, ((<span class="attr">currentHook</span>: any): <span class="title class_">Hook</span>), reducer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ã€è·å–å½“å‰å·¥ä½œHookã€‘updateWorkInProgressHook"><a href="#ã€è·å–å½“å‰å·¥ä½œHookã€‘updateWorkInProgressHook" class="headerlink" title="ã€è·å–å½“å‰å·¥ä½œHookã€‘updateWorkInProgressHook"></a>ã€è·å–å½“å‰å·¥ä½œHookã€‘updateWorkInProgressHook</h5><p><a href="https://github.com/xu-xiaoya/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js#L1044">âœˆï¸ github-ReactFiberHooks.js - updateWorkInProgressHook</a><br><code>updateReducer</code>ä¸­è°ƒç”¨äº† <code>updateWorkInProgressHook</code> ï¼Œè¯¥å‡½æ•°è¿”å›å½“å‰å·¥ä½œçš„Hook, å³ workInProgressHook</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title class_">Hook</span> &#123;</span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå·¥ä½œä¸­çš„Hook</span></span><br><span class="line">  <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">    workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">    nextWorkInProgressHook = workInProgressHook.<span class="property">next</span>;</span><br><span class="line"></span><br><span class="line">    currentHook = nextCurrentHook;</span><br><span class="line">    nextCurrentHook = currentHook !== <span class="literal">null</span> ? currentHook.<span class="property">next</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªå·¥ä½œä¸­çš„Hook</span></span><br><span class="line">    currentHook = nextCurrentHook;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„Hookå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">newHook</span>: <span class="title class_">Hook</span> = &#123;</span><br><span class="line">      <span class="attr">memoizedState</span>: currentHook.<span class="property">memoizedState</span>,</span><br><span class="line"></span><br><span class="line">      <span class="attr">baseState</span>: currentHook.<span class="property">baseState</span>,</span><br><span class="line">      <span class="attr">queue</span>: currentHook.<span class="property">queue</span>,</span><br><span class="line">      <span class="attr">baseUpdate</span>: currentHook.<span class="property">baseUpdate</span>,</span><br><span class="line"></span><br><span class="line">      <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ–°Hookæ·»åŠ åˆ°å·¥ä½œä¸­Hooké“¾è¡¨ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">      workInProgressHook = firstWorkInProgressHook = newHook;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      workInProgressHook = workInProgressHook.<span class="property">next</span> = newHook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°å½“å‰çš„ currentHook</span></span><br><span class="line">    nextCurrentHook = currentHook.<span class="property">next</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è¿”å›å·¥ä½œä¸­çš„Hook</span></span><br><span class="line">  <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>nextWorkInProgressHook</code>å­˜åœ¨ï¼ŒReactå°†ç»§ç»­å¤„ç†<code>workInProgressHook</code>é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªHookã€‚<br>å¦‚æœ<code>nextWorkInProgressHook</code>ä¸å­˜åœ¨ï¼Œè¿™é€šå¸¸æ„å‘³ç€ç»„ä»¶æ­£åœ¨è¿›è¡Œåˆå§‹æ¸²æŸ“ï¼Œæ­¤æ—¶Reactä¼šæ–°å»ºä¸€ä¸ªHookå¹¶å°†å…¶æ·»åŠ åˆ°workInProgressHooké“¾è¡¨ä¸­ã€‚<br>åœ¨æ­£å¸¸çš„é‡æ–°æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œ<code>nextWorkInProgressHook</code>ä¸åº”è¯¥ä¸ºnullã€‚</p><h5 id="updateReducerImpl"><a href="#updateReducerImpl" class="headerlink" title="updateReducerImpl"></a>updateReducerImpl</h5><p>å‡½æ•°è¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼š</p><ul><li>æ›´æ–°åçš„çŠ¶æ€ï¼ˆhook.memoizedStateï¼‰ã€‚</li><li>ä¸€ä¸ªdispatchå‡½æ•°ï¼Œç”¨äºè§¦å‘çŠ¶æ€æ›´æ–°</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> updateReducerImpl&lt;S, A&gt;(</span><br><span class="line">  <span class="attr">hook</span>: <span class="title class_">Hook</span>, <span class="comment">// å½“å‰æ­£åœ¨å¤„ç†çš„Hookå¯¹è±¡</span></span><br><span class="line">  <span class="attr">current</span>: <span class="title class_">Hook</span>, <span class="comment">// ä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶çš„Hookå¯¹è±¡</span></span><br><span class="line">  <span class="attr">reducer</span>: <span class="function">(<span class="params">S, A</span>) =&gt;</span> S, <span class="comment">// ç”¨äºå¤„ç†actionå¹¶è¿”å›æ–°çŠ¶æ€çš„reducerå‡½æ•°</span></span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;A&gt;] &#123;</span><br><span class="line">  <span class="comment">// è·å–Hookçš„æ›´æ–°é˜Ÿåˆ—</span></span><br><span class="line">  <span class="keyword">const</span> queue = hook.<span class="property">queue</span>;</span><br><span class="line">  queue.<span class="property">lastRenderedReducer</span> = reducer;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// baseQueueå­˜å‚¨çš„æ˜¯å°šæœªè¢«å¤„ç†çš„æ›´æ–°</span></span><br><span class="line">  <span class="keyword">let</span> baseQueue = hook.<span class="property">baseQueue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜äº†å½“å‰æ¸²æŸ“å‘¨æœŸä¸­æ–°å¢çš„æ›´æ–°</span></span><br><span class="line">  <span class="keyword">const</span> pendingQueue = queue.<span class="property">pending</span>;</span><br><span class="line">  <span class="keyword">if</span> (pendingQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨å¾…å¤„ç†çš„æ›´æ–°ï¼Œå¹¶ä¸”baseQueueä¹Ÿä¸ä¸ºç©ºï¼Œåˆ™å°†ä¸¤è€…åˆå¹¶</span></span><br><span class="line">    <span class="keyword">if</span> (baseQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> baseFirst = baseQueue.<span class="property">next</span>;</span><br><span class="line">      <span class="keyword">const</span> pendingFirst = pendingQueue.<span class="property">next</span>;</span><br><span class="line">      baseQueue.<span class="property">next</span> = pendingFirst;</span><br><span class="line">      pendingQueue.<span class="property">next</span> = baseFirst;</span><br><span class="line">    &#125;</span><br><span class="line">    current.<span class="property">baseQueue</span> = baseQueue = pendingQueue;</span><br><span class="line">    queue.<span class="property">pending</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–Hookçš„åˆå§‹çŠ¶æ€</span></span><br><span class="line">  <span class="keyword">const</span> baseState = hook.<span class="property">baseState</span>;</span><br><span class="line">  <span class="keyword">if</span> (baseQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰å¾…å¤„ç†çš„æ›´æ–°ï¼Œåˆ™ç›´æ¥å°†baseStateä½œä¸ºmemoizedState</span></span><br><span class="line">    hook.<span class="property">memoizedState</span> = baseState;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// å¦‚æœæœ‰å¾…å¤„ç†çš„æ›´æ–°ï¼Œåˆ™å¼€å§‹å¤„ç†è¿™äº›æ›´æ–°</span></span><br><span class="line">    <span class="keyword">const</span> first = baseQueue.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">let</span> newState = baseState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹å˜é‡ç”¨äºæ„å»ºæ–°çš„baseQueueå’ŒbaseState</span></span><br><span class="line">    <span class="keyword">let</span> newBaseState = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> newBaseQueueFirst = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">newBaseQueueLast</span>: <span class="title class_">Update</span>&lt;S, A&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> update = first;</span><br><span class="line">    <span class="keyword">let</span> didReadFromEntangledAsyncAction = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†æ›´æ–°é˜Ÿåˆ—ï¼Œç›´åˆ°å›åˆ°èµ·ç‚¹ï¼ˆå› ä¸ºé˜Ÿåˆ—æ˜¯å¾ªç¯çš„ï¼‰</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="comment">// çœç•¥äº†éƒ¨åˆ†ä»£ç ï¼Œä¸»è¦å¤„ç†æ›´æ–°çš„ä¼˜å…ˆçº§ã€æ˜¯å¦è·³è¿‡æ›´æ–°ç­‰é€»è¾‘</span></span><br><span class="line">      <span class="comment">// ....</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// å¤„ç†å½“å‰æ›´æ–°</span></span><br><span class="line">      <span class="keyword">const</span> action = update.<span class="property">action</span>;</span><br><span class="line">      <span class="comment">// åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œå¯èƒ½ä¼šåŒæ¬¡è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°ï¼ˆä¸ºäº†æ£€æµ‹å‰¯ä½œç”¨ï¼‰</span></span><br><span class="line">      <span class="keyword">if</span> (shouldDoubleInvokeUserFnsInHooksDEV) &#123;</span><br><span class="line">        <span class="title function_">reducer</span>(newState, action);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ ¹æ®æ›´æ–°æ˜¯å¦æœ‰æ€¥åˆ‡çŠ¶æ€ï¼ˆeagerStateï¼‰ï¼Œå†³å®šå¦‚ä½•æ›´æ–°newState</span></span><br><span class="line">      <span class="keyword">if</span> (update.<span class="property">hasEagerState</span>) &#123;</span><br><span class="line">        newState = ((update.<span class="property">eagerState</span>: any): S);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newState = <span class="title function_">reducer</span>(newState, action);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ›´æ–°</span></span><br><span class="line">      update = update.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„å»ºæ–°çš„baseQueueå’ŒbaseState </span></span><br><span class="line">    <span class="keyword">if</span> (newBaseQueueLast === <span class="literal">null</span>) &#123;</span><br><span class="line">      newBaseState = newState;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newBaseQueueLast.<span class="property">next</span> = (<span class="attr">newBaseQueueFirst</span>: any);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœnewStateä¸memoizedStateä¸åŒï¼Œåˆ™æ ‡è®°å·¥ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¹¶æ›´æ–°memoizedStateã€baseStateå’ŒbaseQueue</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">is</span>(newState, hook.<span class="property">memoizedState</span>)) &#123;</span><br><span class="line">      <span class="title function_">markWorkInProgressReceivedUpdate</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hook.<span class="property">memoizedState</span> = newState;</span><br><span class="line">    hook.<span class="property">baseState</span> = newBaseState;</span><br><span class="line">    hook.<span class="property">baseQueue</span> = newBaseQueueLast;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°é˜Ÿåˆ—çš„lastRenderedStateä¸ºæœ€æ–°çš„çŠ¶æ€</span></span><br><span class="line">    queue.<span class="property">lastRenderedState</span> = newState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰å¾…å¤„ç†çš„æ›´æ–°ï¼Œåˆ™æ¸…ç©ºé˜Ÿåˆ—çš„lanes</span></span><br><span class="line">  <span class="keyword">if</span> (baseQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    queue.<span class="property">lanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›æ›´æ–°åçš„çŠ¶æ€å’Œdispatchå‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;A&gt; = (queue.<span class="property">dispatch</span>: any);</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“useStateçš„æ‰§è¡Œæµç¨‹"><a href="#æ€»ç»“useStateçš„æ‰§è¡Œæµç¨‹" class="headerlink" title="æ€»ç»“useStateçš„æ‰§è¡Œæµç¨‹"></a>æ€»ç»“useStateçš„æ‰§è¡Œæµç¨‹</h2><p>åˆå§‹åŒ–ï¼š æ„å»ºdispatcherå‡½æ•°å’Œåˆå§‹å€¼</p><p>æ›´æ–°æ—¶ï¼š<br>è§¦å‘dispatchæ—¶æŒ‰åºæ’å…¥update, updateStateçš„æ—¶å€™å†æŒ‰åºè§¦å‘reducerã€‚å¯ä»¥è¯´å°±æ˜¯ä¸€ä¸ªç®€å•çš„reduxã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®ç°è™šå®çº¿ç»“åˆçš„æŠ˜çº¿å›¾Echarts</title>
      <link href="/2023/07/17/article4/"/>
      <url>/2023/07/17/article4/</url>
      
        <content type="html"><![CDATA[<p>é‡åˆ°å®é™…ä¸é¢„æµ‹çš„éœ€æ±‚æ—¶ï¼Œç»å¸¸ä¼šæœ‰è¶‹åŠ¿å›¾å®çº¿ä¸è™šçº¿ç»“åˆçš„éœ€æ±‚ï¼Œåˆ†äº«ä¸€ä¸‹å®ç°å…³é”®ç‚¹</p><h1 id="æœ€ç»ˆæ•ˆæœ"><a href="#æœ€ç»ˆæ•ˆæœ" class="headerlink" title="æœ€ç»ˆæ•ˆæœ"></a>æœ€ç»ˆæ•ˆæœ</h1><p>å †å æŠ˜çº¿å›¾ï¼ŒåŒºåˆ†ä¸åŒæ•°æ®æ®µçš„å®çº¿å’Œè™šçº¿ï¼š<br><img src="/img/article4/article4-4.jpg" alt="å®ç°è™šå®çº¿ç»“åˆçš„æŠ˜çº¿å›¾Echarts" width="70%"></p><h2 id="æ€è·¯1-stackåˆ†å‰²ï¼ˆå¤±è´¥ï¼‰"><a href="#æ€è·¯1-stackåˆ†å‰²ï¼ˆå¤±è´¥ï¼‰" class="headerlink" title="æ€è·¯1: stackåˆ†å‰²ï¼ˆå¤±è´¥ï¼‰"></a>æ€è·¯1: stackåˆ†å‰²ï¼ˆå¤±è´¥ï¼‰</h2><p>çœ‹åˆ°è¿™ä¸ªæ•ˆæœå›¾ï¼Œæƒ³åˆ°å¯ä»¥é€šè¿‡è®¾ç½® <code>series</code> ä¸­çš„ <code>stack</code>æ¥å®ç°ï¼Œå¹¶ä½¿ç”¨<code>lineStyle</code> å±æ€§æ¥æ§åˆ¶çº¿æ¡çš„å®çº¿æˆ–è™šçº¿æ ·å¼ã€‚å¦‚nameä¸ºâ€ç³»åˆ—1â€æ—¶ï¼Œseriesä¸­éœ€è¦è®¾ç½®ä¸¤ä¸ªå­å¯¹è±¡ï¼Œä¸€ä¸ªå®çº¿ï¼Œä¸€ä¸ªè™šçº¿ï¼Œå¹¶å¡«å……å¯¹åº”çš„<code>data</code>ã€‚<br>é…ç½®å’Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š<br><img src="/img/article4/article4-1.jpg" width="70%"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">series<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">    stack<span class="punctuation">:</span> &#x27;æ€»é‡&#x27;<span class="punctuation">,</span></span><br><span class="line">    data<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">120</span><span class="punctuation">,</span> <span class="number">132</span><span class="punctuation">,</span> <span class="number">101</span><span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">    lineStyle<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      type<span class="punctuation">:</span> &#x27;dashed&#x27;</span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    stack<span class="punctuation">:</span> &#x27;æ€»é‡&#x27;<span class="punctuation">,</span></span><br><span class="line">    data<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> <span class="number">134</span><span class="punctuation">,</span> <span class="number">90</span><span class="punctuation">,</span> <span class="number">230</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">2</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">    stack<span class="punctuation">:</span> &#x27;æ€»é‡&#x27;<span class="punctuation">,</span></span><br><span class="line">    data<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">220</span><span class="punctuation">,</span> <span class="number">182</span><span class="punctuation">,</span> <span class="number">191</span><span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">2</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">    lineStyle<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      type<span class="punctuation">:</span> &#x27;dashed&#x27;</span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    stack<span class="punctuation">:</span> &#x27;æ€»é‡&#x27;<span class="punctuation">,</span></span><br><span class="line">    data<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> <span class="number">234</span><span class="punctuation">,</span> <span class="number">290</span><span class="punctuation">,</span> <span class="number">330</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶æ•°æ®æ­£ç¡®å±•ç¤ºä¸Šäº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šå‘ç°ä¸¤æ®µæ•°æ®æ–­èŠ‚äº†ï¼Ÿ<br>äºæ˜¯ï¼Œå°è¯•æŠŠä¸¤æ®µçš„dataè®¾ç½®ä¸€ä¸ªç›¸åŒçš„å€¼:</p><div style="display: flex;">  <div>    <img src="/img/article4/article4-2.jpg" >  </div>  <div>  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">  type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">  stack<span class="punctuation">:</span> &#x27;æ€»é‡&#x27;<span class="punctuation">,</span></span><br><span class="line">  data<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">120</span><span class="punctuation">,</span> <span class="number">132</span><span class="punctuation">,</span> <span class="number">101</span><span class="punctuation">,</span> <span class="number">134</span><span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">  type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">  lineStyle<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    type<span class="punctuation">:</span> &#x27;dashed&#x27;</span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  stack<span class="punctuation">:</span> &#x27;æ€»é‡&#x27;<span class="punctuation">,</span></span><br><span class="line">  data<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> <span class="number">134</span><span class="punctuation">,</span> <span class="number">90</span><span class="punctuation">,</span> <span class="number">230</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>  </div></div>å‘ç°å †å å›¾æ— æ³•å®ç°è¯¥æ•ˆæœï¼Œechartså†…éƒ¨å°†äº¤ç‚¹çš„æ•°æ®é‡å¤ç»˜åˆ¶äº†ä¸¤æ¬¡ã€‚<h2 id="æ€è·¯2-ç›´æ¥ä½¿ç”¨æŠ˜çº¿å›¾"><a href="#æ€è·¯2-ç›´æ¥ä½¿ç”¨æŠ˜çº¿å›¾" class="headerlink" title="æ€è·¯2: ç›´æ¥ä½¿ç”¨æŠ˜çº¿å›¾"></a>æ€è·¯2: ç›´æ¥ä½¿ç”¨æŠ˜çº¿å›¾</h2><p>æ¢ä¸ªæ€è·¯ï¼Œå¦‚æœå»æ‰<code>stack</code>ç›´æ¥ä½¿ç”¨æŠ˜çº¿å›¾å‘¢ï¼Ÿ<br>æˆ‘ä»¬å‘ç°ä¸¤æ®µæ•°æ®å¯ä»¥è¿ä¸Šäº†ï¼</p><div style="display: flex;">  <div>    <img src="/img/article4/article4-3.jpg" >  </div>  <div>  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">  type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">  data<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">120</span><span class="punctuation">,</span> <span class="number">132</span><span class="punctuation">,</span> <span class="number">101</span><span class="punctuation">,</span> <span class="number">134</span><span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  name<span class="punctuation">:</span> &#x27;ç³»åˆ—<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">  type<span class="punctuation">:</span> &#x27;line&#x27;<span class="punctuation">,</span></span><br><span class="line">  lineStyle<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    type<span class="punctuation">:</span> &#x27;dashed&#x27;</span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  data<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> &#x27;-&#x27;<span class="punctuation">,</span> <span class="number">134</span><span class="punctuation">,</span> <span class="number">90</span><span class="punctuation">,</span> <span class="number">230</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>  </div></div><p>ä½†tooltip æç¤ºä¼šå­˜åœ¨å¤šä¸ªåŒåçš„æç¤ºï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†è¿‡æ»¤æ— æ•ˆå€¼å’Œäº¤å‰çš„å€¼ï¼Œæœ€ç»ˆå°±å¤§åŠŸå‘Šæˆå•¦ï½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tooltip</span>: &#123;</span><br><span class="line">  <span class="attr">trigger</span>: <span class="string">&#x27;axis&#x27;</span>, <span class="comment">// è®¾ç½®è§¦å‘ç±»å‹ä¸ºåæ ‡è½´è§¦å‘</span></span><br><span class="line">  <span class="title function_">formatter</span>(<span class="params">params</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> hasMap = &#123;&#125;; <span class="comment">// åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ¥è®°å½•å·²ç»å¤„ç†è¿‡çš„ç³»åˆ—åç§°å’Œå€¼</span></span><br><span class="line">    <span class="keyword">let</span> html = <span class="string">`<span class="subst">$&#123;params[<span class="number">0</span>].name&#125;</span>&lt;br&gt;`</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> param <span class="keyword">of</span> params) &#123;</span><br><span class="line">      <span class="comment">// è¿‡æ»¤æ— æ•ˆå€¼å’Œé‡å å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (param.<span class="property">value</span> !== <span class="string">&#x27;-&#x27;</span> &amp;&amp; !hasMap[param.<span class="property">seriesName</span>]) &#123;</span><br><span class="line">        <span class="comment">// è®°å½•å·²å¤„ç†çš„ç³»åˆ—åç§°å’Œå€¼</span></span><br><span class="line">        hasMap[param.<span class="property">seriesName</span>] = param.<span class="property">value</span>;</span><br><span class="line">        html += <span class="string">`&lt;span style=&quot;display: block;&quot;&gt;<span class="subst">$&#123;param.seriesName&#125;</span>: <span class="subst">$&#123;param.value&#125;</span>&lt;/span&gt;`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;div style=&quot;text-align:left&quot;&gt;<span class="subst">$&#123;html&#125;</span>&lt;/div&gt;`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> é¡¹ç›®å®æˆ˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ReactæŠ¥é”™#310å¤ç›˜å°ç»“+hooksä½¿ç”¨çš„åœºæ™¯+è°ƒç”¨åŸç†</title>
      <link href="/2023/06/30/article2/"/>
      <url>/2023/06/30/article2/</url>
      
        <content type="html"><![CDATA[<h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>apmæŠ¥é”™ï¼š<strong>Minified React error #310</strong><br><a href="https://react.dev/errors/310?invariant=310">https://react.dev/errors/310?invariant=310</a><br><img src="/img/article2/article2-error.jpg"><br>å½“æˆ‘ä»¬æœ‰æ¡ä»¶åœ°è°ƒç”¨ä¸€ä¸ªé’©å­æˆ–åœ¨æ‰€æœ‰é’©å­è¿è¡Œä¹‹å‰æå‰è¿”å›æ—¶ï¼Œä¼šäº§ç”Ÿâ€Rendered more hooks than during the previous renderâ€é”™è¯¯ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><div style="display: flex;">  <div style="width: 49%;">    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ä»£ç </span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    â€¦â€¦â€¦â€¦</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (æ¡ä»¶) &#123;</span><br><span class="line">      <span class="keyword">return</span> (â€¦â€¦)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">-   <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">-   <span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>, [â€¦â€¦])</span><br><span class="line">    <span class="keyword">return</span> (â€¦â€¦)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  </div>  <span style="width: 2%;"></span>  <div style="width: 49%;">    <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£ç¡®ä»£ç </span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    â€¦â€¦â€¦â€¦</span><br><span class="line">+   <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">+   <span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>, [â€¦â€¦])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (æ¡ä»¶) &#123;</span><br><span class="line">      <span class="keyword">return</span> (â€¦â€¦)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> (â€¦â€¦)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  </div></div><p>ifä¸­ <code>return</code>  é˜»å¡äº†åç»­hookçš„æ¸²æŸ“ï¼Œä¸ºäº†è§£å†³è¯¥é”™è¯¯ï¼Œå°†æ‰€æœ‰çš„é’©å­<b>ç§»åˆ°å‡½æ•°ç»„ä»¶çš„é¡¶å±‚</b>ï¼Œä»¥åŠä¸è¦åœ¨æ¡ä»¶ä¸­ä½¿ç”¨é’©å­ã€‚</p><h2 id="åŸç†-å­¦ä¹ "><a href="#åŸç†-å­¦ä¹ " class="headerlink" title="åŸç†&amp;å­¦ä¹ "></a>åŸç†&amp;å­¦ä¹ </h2><p>React ä¾èµ–äº <strong>Hook è°ƒç”¨çš„é¡ºåº</strong>ã€‚<br>åœ¨æ­£å¸¸çš„ç¨‹åºä¸­ï¼ŒHook çš„è°ƒç”¨é¡ºåºåœ¨æ¯æ¬¡æ¸²æŸ“ä¸­éƒ½æ˜¯ç›¸åŒçš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">const</span> [test, setTest] = <span class="title function_">useState</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–æ¬¡æ¸²æŸ“</span></span><br><span class="line"><span class="title function_">useState</span>(<span class="string">&#x27;false&#x27;</span>)            <span class="comment">// 1. ä½¿ç”¨ false åˆå§‹åŒ–å˜é‡åä¸º loading çš„ state</span></span><br><span class="line"><span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>)             <span class="comment">// 2. æ·»åŠ  effect ä»¥ä¿å­˜ form æ“ä½œ</span></span><br><span class="line"><span class="title function_">useState</span>(<span class="string">&#x27;name&#x27;</span>)            <span class="comment">// 3. ä½¿ç”¨ &#x27;Poppins&#x27; åˆå§‹åŒ–å˜é‡åä¸º surname çš„ state</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// äºŒæ¬¡æ¸²æŸ“</span></span><br><span class="line"><span class="title function_">useState</span>(<span class="string">&#x27;false&#x27;</span>)            <span class="comment">// 1. è¯»å–å˜é‡åä¸º loading çš„ stateï¼ˆå‚æ•°è¢«å¿½ç•¥ï¼‰</span></span><br><span class="line"><span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>)             <span class="comment">// 2. æ›¿æ¢ä¿å­˜ form çš„ effect</span></span><br><span class="line"><span class="title function_">useState</span>(<span class="string">&#x27;name&#x27;</span>)            <span class="comment">// 3. è¯»å–å˜é‡åä¸º surname çš„ stateï¼ˆå‚æ•°è¢«å¿½ç•¥ï¼‰</span></span><br></pre></td></tr></table></figure><p><span style="color: red;">åªè¦ Hook çš„è°ƒç”¨é¡ºåºåœ¨å¤šæ¬¡æ¸²æŸ“ä¹‹é—´ä¿æŒä¸€è‡´ï¼ŒReact å°±èƒ½æ­£ç¡®åœ°å°†å†…éƒ¨ state å’Œå¯¹åº”çš„ Hook è¿›è¡Œå…³è”ã€‚</span></p><p>é‚£å¦‚æœåœ¨æ­£å¸¸ç¨‹åºä¸­æ’å…¥ä¸€ä¸ªifè¯­å¥å‘¢ï¼Ÿå¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> (æ¡ä»¶) &#123;</span><br><span class="line">      <span class="keyword">return</span> ï¼ˆï¼‰</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> [test, setTest] = <span class="title function_">useState</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ifæ¡ä»¶çš„å­˜åœ¨å¯¼è‡´ç¨‹åºæå‰ç»ˆæ­¢ï¼Œä¸å†æ‰§è¡Œä¸‹æ–¹è¯­å¥ï¼ˆè€Œä¸‹æ–¹åˆå­˜åœ¨ä¸€äº›hookï¼‰ï¼Œå¯¼è‡´ä¸¤ç§æ¸²æŸ“æƒ…å†µä¸ä¸€è‡´ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿›å…¥ifæ²¡return</span></span><br><span class="line"><span class="title function_">useState</span>(<span class="string">&#x27;false&#x27;</span>)            <span class="comment">// 1. ä½¿ç”¨ false åˆå§‹åŒ–å˜é‡åä¸º loading çš„ state</span></span><br><span class="line"><span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>)             <span class="comment">// 2. æ·»åŠ  effect ä»¥ä¿å­˜ form æ“ä½œ</span></span><br><span class="line"><span class="title function_">useState</span>(<span class="string">&#x27;name&#x27;</span>)            <span class="comment">// 3. ä½¿ç”¨ &#x27;Poppins&#x27; åˆå§‹åŒ–å˜é‡åä¸º surname çš„ state</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›å…¥ifå¹¶return</span></span><br><span class="line"><span class="title function_">useState</span>(<span class="string">&#x27;false&#x27;</span>)             <span class="comment">// 1. è¯»å–å˜é‡åä¸º loading çš„ stateï¼ˆå‚æ•°è¢«å¿½ç•¥ï¼‰</span></span><br><span class="line"><span class="title function_">useEffect</span>(å‡½æ•°<span class="number">1</span>)              <span class="comment">// 2. æ›¿æ¢ä¿å­˜ form çš„ effect</span></span><br><span class="line"><span class="comment">//useState(&#x27;name&#x27;)           // 3. æ­¤ Hook è¢«å¿½ç•¥ï¼</span></span><br></pre></td></tr></table></figure><h2 id="å¼•å‘é”™è¯¯æƒ…å†µ"><a href="#å¼•å‘é”™è¯¯æƒ…å†µ" class="headerlink" title="å¼•å‘é”™è¯¯æƒ…å†µ"></a>å¼•å‘é”™è¯¯æƒ…å†µ</h2><p><a href="https://zh-hans.reactjs.org/docs/hooks-rules.html">https://zh-hans.reactjs.org/docs/hooks-rules.html</a></p><h3 id="1-ä¸è¦åœ¨å¾ªç¯ï¼Œæ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨-Hook"><a href="#1-ä¸è¦åœ¨å¾ªç¯ï¼Œæ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨-Hook" class="headerlink" title="1. ä¸è¦åœ¨å¾ªç¯ï¼Œæ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨ Hook"></a>1. ä¸è¦åœ¨å¾ªç¯ï¼Œæ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨ Hook</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [counter, setCounter] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">-  <span class="keyword">if</span> (counter &gt; <span class="number">0</span>) &#123;</span><br><span class="line">-    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">-      <span class="variable language_">console</span>.<span class="title function_">log</span>(counter);</span><br><span class="line">-    &#125;);</span><br><span class="line">-  &#125;</span><br><span class="line"><span class="comment">// å°†ifæ¡ä»¶è¯­å¥ç§»åˆ°useEffecté’©å­å†…éƒ¨</span></span><br><span class="line">+  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">+    <span class="keyword">if</span> (counter &gt; <span class="number">0</span>) &#123;</span><br><span class="line">+      <span class="variable language_">console</span>.<span class="title function_">log</span>(counter);</span><br><span class="line">+    &#125;</span><br><span class="line">+  &#125;);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-æŠŠæ‰€æœ‰çš„é’©å­ç§»åˆ°ç»„ä»¶çš„é¡¶å±‚ï¼Œåœ¨ä»»ä½•å¯èƒ½è¿”å›å€¼çš„æ¡ä»¶ä¹‹ä¸Šã€‚"><a href="#2-æŠŠæ‰€æœ‰çš„é’©å­ç§»åˆ°ç»„ä»¶çš„é¡¶å±‚ï¼Œåœ¨ä»»ä½•å¯èƒ½è¿”å›å€¼çš„æ¡ä»¶ä¹‹ä¸Šã€‚" class="headerlink" title="2. æŠŠæ‰€æœ‰çš„é’©å­ç§»åˆ°ç»„ä»¶çš„é¡¶å±‚ï¼Œåœ¨ä»»ä½•å¯èƒ½è¿”å›å€¼çš„æ¡ä»¶ä¹‹ä¸Šã€‚"></a>2. æŠŠæ‰€æœ‰çš„é’©å­ç§»åˆ°ç»„ä»¶çš„é¡¶å±‚ï¼Œåœ¨ä»»ä½•å¯èƒ½è¿”å›å€¼çš„æ¡ä»¶ä¹‹ä¸Šã€‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [counter, setCounter] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">+ <span class="keyword">const</span> [color, setColor] = <span class="title function_">useState</span>(<span class="string">&#x27;salmon&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (counter &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Returning early<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Error: è¯¥hookåœ¨counter&lt;=0æ¡ä»¶æ—¶ï¼Œæ‰è¢«è°ƒç”¨</span></span><br><span class="line">- <span class="keyword">const</span> [color, setColor] = <span class="title function_">useState</span>(<span class="string">&#x27;salmon&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCounter(counter + 1)&#125;&gt;toggle loading<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello world<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-Reactå‡½æ•°ç»„ä»¶æˆ–è‡ªå®šä¹‰é’©å­ä¸­åªåœ¨è°ƒç”¨Hook"><a href="#3-Reactå‡½æ•°ç»„ä»¶æˆ–è‡ªå®šä¹‰é’©å­ä¸­åªåœ¨è°ƒç”¨Hook" class="headerlink" title="3. Reactå‡½æ•°ç»„ä»¶æˆ–è‡ªå®šä¹‰é’©å­ä¸­åªåœ¨è°ƒç”¨Hook"></a>3. Reactå‡½æ•°ç»„ä»¶æˆ–è‡ªå®šä¹‰é’©å­ä¸­åªåœ¨è°ƒç”¨Hook</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ™®é€šå‡½æ•°ä¸­ä¸è¦ä½¿ç”¨hook</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">AppContent</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [counter, setCounter] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    â€¦â€¦â€¦â€¦</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">App</span> = &#123;</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;app&#x27;</span>,</span><br><span class="line">- <span class="attr">render</span>: <span class="title class_">AppContent</span>,</span><br><span class="line">+ <span class="attr">render</span>: <span class="function">() =&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">AppContent</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>åªä»Reactå‡½æ•°ç»„ä»¶æˆ–è‡ªå®šä¹‰é’©å­ä¸­è°ƒç”¨Hook</li><li>åªåœ¨æœ€é¡¶å±‚ä½¿ç”¨ Hook</li><li>ä¸è¦åœ¨å¾ªç¯ï¼Œæ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨ Hook</li><li>ç¡®ä¿æ€»æ˜¯åœ¨ä½ çš„ React å‡½æ•°çš„æœ€é¡¶å±‚ä»¥åŠä»»ä½• return ä¹‹å‰ä½¿ç”¨ Hook</li></ul><p>è¿™æœ‰åŠ©äºReactåœ¨å¤šä¸ª<code>useState</code>å’Œ<code>useEffect</code>è°ƒç”¨ä¹‹é—´ä¿ç•™é’©å­çš„çŠ¶æ€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
